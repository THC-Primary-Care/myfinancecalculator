<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>PCN ARRS Workforce Planning Calculator 2025-26</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        --primary-color: #00999e;
        --secondary-color: #00b5bb;
        --accent-color: #00ccd2;
        --success-color: #34a853;
        --warning-color: #ea4335;
        --background-color: #f8f9fa;
        --card-bg: #ffffff;
        --text-color: #202124;
        --border-color: #dadce0;
      }

      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      body {
        font-family: "Poppins", sans-serif;
        line-height: 1.6;
        color: var(--text-color);
        background-color: var(--background-color);
        padding: 20px;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
      }

      header {
        margin-bottom: 30px;
        padding-bottom: 20px;
        border-bottom: 1px solid var(--border-color);
      }

      h1 {
        font-size: 2.2rem;
        color: var(--primary-color);
        text-shadow: 1px 1px 0 rgba(0, 0, 0, 0.05);
        position: relative;
        display: inline-block;
      }

      h1:after {
        content: "";
        position: absolute;
        bottom: -10px;
        left: 0;
        width: 100px;
        height: 4px;
        background-color: var(--primary-color);
        border-radius: 2px;
      }

      h1,
      h2,
      h3 {
        margin-bottom: 0.5em;
        color: var(--primary-color);
      }

      .tabs {
        display: flex;
        border-bottom: 2px solid var(--border-color);
        margin-bottom: 20px;
      }

      .tab {
        padding: 10px 20px;
        cursor: pointer;
        margin-right: 5px;
        border-top-left-radius: 5px;
        border-top-right-radius: 5px;
        transition: all 0.3s ease;
        font-weight: 500;
        position: relative;
        overflow: hidden;
      }

      .tab:before {
        content: "";
        position: absolute;
        bottom: 0;
        left: 0;
        width: 0;
        height: 3px;
        background-color: var(--primary-color);
        transition: width 0.3s ease;
      }

      .tab:hover:before {
        width: 100%;
      }

      .tab:hover {
        color: var(--primary-color);
      }

      .tab.active {
        background-color: var(--primary-color);
        color: white;
      }

      .tab-content {
        display: none;
      }

      .tab-content.active {
        display: block;
      }

      .card {
        background-color: var(--card-bg);
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        padding: 25px;
        margin-bottom: 25px;
        transition: transform 0.2s, box-shadow 0.2s;
      }

      .card:hover {
        transform: translateY(-3px);
        box-shadow: 0 6px 25px rgba(0, 0, 0, 0.12);
      }

      .form-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 20px;
      }

      .form-group {
        margin-bottom: 15px;
      }

      label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
      }

      input,
      select,
      textarea {
        width: 100%;
        padding: 10px;
        border: 1px solid var(--border-color);
        border-radius: 4px;
        font-size: 16px;
      }

      .form-actions {
        margin-top: 20px;
        display: flex;
        gap: 10px;
      }

      button {
        padding: 10px 20px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 16px;
        font-weight: bold;
      }

      button.primary {
        background-color: var(--primary-color);
        color: white;
        transition: all 0.3s ease;
      }

      button.primary:hover {
        background-color: var(--secondary-color);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 153, 158, 0.3);
      }

      button.secondary {
        background-color: var(--background-color);
        border: 1px solid var(--border-color);
        transition: all 0.3s ease;
      }

      button.secondary:hover {
        background-color: #f0f0f0;
        border-color: var(--primary-color);
      }

      button.remove {
        background-color: var(--warning-color);
        color: white;
        transition: all 0.3s ease;
      }

      button.remove:hover {
        background-color: #d33426;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(234, 67, 53, 0.3);
      }

      .staff-item {
        background-color: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 20px;
        position: relative;
        transition: all 0.3s ease;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
      }

      .staff-item:hover {
        box-shadow: 0 5px 15px rgba(0, 153, 158, 0.15);
        transform: translateY(-3px);
        border-color: var(--primary-color);
      }

      .staff-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
      }

      .status-indicator {
        padding: 5px 10px;
        border-radius: 4px;
        font-size: 14px;
        font-weight: bold;
      }

      .status-ok {
        background-color: rgba(52, 168, 83, 0.2);
        color: var(--success-color);
      }

      .status-warning {
        background-color: rgba(234, 67, 53, 0.2);
        color: var(--warning-color);
      }

      .staff-details {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 10px;
      }

      .staff-detail span {
        font-weight: bold;
      }

      .remove-staff {
        position: absolute;
        top: 10px;
        right: 10px;
        width: 30px;
        height: 30px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        background-color: var(--warning-color);
        color: white;
        font-size: 20px;
        padding: 0;
      }

      .summary-card {
        background-color: var(--primary-color);
        color: white;
      }

      .summary-card h2,
      .summary-card h3 {
        color: white;
      }

      .location-display {
        font-size: 0.6em;
        font-weight: normal;
        background-color: rgba(255, 255, 255, 0.2);
        padding: 3px 8px;
        border-radius: 12px;
        margin-left: 10px;
        vertical-align: middle;
      }

      .band-filters {
        display: flex;
        flex-wrap: wrap;
        gap: 5px;
      }

      .band-filter {
        background-color: #f0f0f0;
        border: 1px solid #ddd;
        color: #333;
        padding: 5px 10px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.9em;
        transition: all 0.2s ease;
      }

      .band-filter:hover {
        background-color: #e0e0e0;
      }

      .band-filter.active {
        background-color: var(--primary-color);
        color: white;
        border-color: var(--primary-color);
      }

      .summary-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 20px;
      }

      .summary-item {
        background-color: rgba(255, 255, 255, 0.1);
        padding: 15px;
        border-radius: 8px;
      }

      .summary-value {
        font-size: 24px;
        font-weight: bold;
        margin-top: 10px;
      }

      .backup-area {
        width: 100%;
        height: 200px;
        font-family: monospace;
        margin-bottom: 10px;
      }

      .controls {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
      }

      .note {
        padding: 15px;
        background-color: rgba(0, 153, 158, 0.1);
        border-radius: 4px;
        color: var(--primary-color);
      }

      ul,
      ol {
        margin-left: 20px;
        margin-bottom: 20px;
      }

      footer {
        text-align: center;
        margin-top: 60px;
        padding: 30px 20px;
        border-top: 1px solid var(--border-color);
        color: #666;
        background-color: #f0f5f5;
        border-radius: 12px;
      }

      /* Notifications */
      .notification {
        position: fixed;
        bottom: -100px;
        left: 50%;
        transform: translateX(-50%);
        background-color: var(--primary-color);
        color: white;
        padding: 15px 30px;
        border-radius: 8px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        transition: all 0.3s ease;
        z-index: 1000;
        opacity: 0;
      }

      .notification.show {
        bottom: 20px;
        opacity: 1;
      }

      /* Field Error */
      .field-error {
        color: var(--warning-color);
        font-size: 0.8rem;
        margin-top: 5px;
        font-weight: 500;
        animation: shake 0.5s ease-in-out;
      }

      @keyframes shake {
        0%,
        100% {
          transform: translateX(0);
        }
        10%,
        30%,
        50%,
        70%,
        90% {
          transform: translateX(-5px);
        }
        20%,
        40%,
        60%,
        80% {
          transform: translateX(5px);
        }
      }

      /* Financial Calculator Styles */
      .checkbox-container {
        display: flex;
        align-items: center;
        margin-bottom: 10px;
      }

      .checkbox-container input[type="checkbox"] {
        width: auto;
        margin-right: 10px;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      th,
      td {
        padding: 12px;
        text-align: left;
        border-bottom: 1px solid #ddd;
      }

      th {
        background-color: var(--primary-color);
        color: white;
      }

      tr:nth-child(even) {
        background-color: #f9f9f9;
      }

      .totals-row {
        background-color: #e6f7f7;
        font-weight: bold;
      }

      .form-row {
        display: flex;
        gap: 20px;
        margin-bottom: 15px;
      }

      .form-col {
        flex: 1;
      }

      /* Responsive design */
      /* Copyright notice */
      .copyright-notice {
        margin-top: 30px;
        padding-top: 10px;
        border-top: 1px solid var(--border-color);
        font-size: 0.8rem;
        color: #666;
        text-align: center;
      }

      @media (max-width: 768px) {
        .form-grid,
        .staff-details,
        .summary-grid {
          grid-template-columns: 1fr;
        }

        .tabs {
          flex-wrap: wrap;
        }

        .controls {
          flex-direction: column;
        }

        .controls button {
          width: 100%;
          margin-bottom: 10px;
        }

        .form-row {
          flex-direction: column;
          gap: 5px;
        }

        table {
          font-size: 0.85rem;
        }

        th,
        td {
          padding: 8px;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <header>
        <h1>PCN ARRS Workforce Planning Calculator 2025-26</h1>
        <div class="tabs">
          <div class="tab active" data-tab="calculator">ARRS Calculator</div>
          <div class="tab" data-tab="comparison">ARRS Comparison</div>
          <div class="tab" data-tab="monthly">Monthly Tracker</div>
          <div class="tab" data-tab="forecast">ARRS Forecast</div>
          <div class="tab" data-tab="bandings">ARRS Bandings</div>
          <div class="tab" data-tab="finance">Financial Entitlements</div>
          <div class="tab" data-tab="data">Data Management</div>
          <div class="tab" data-tab="about">About</div>
        </div>
      </header>

      <div class="content">
        <div class="tab-content active" data-tab="calculator">
          <div class="card" id="arrs-entitlement-card">
            <h2>ARRS Funding Entitlement</h2>
            <div class="note" style="margin-bottom: 15px">
              <span id="arrs-note-with-population" style="display: none">
                Your ARRS funding is calculated based on the weighted population
                you entered in the Financial Entitlements tab.
              </span>
              <span id="arrs-note-no-population">
                Enter your PCN weighted population in the Financial Entitlements
                tab to calculate your ARRS allocation.
              </span>
            </div>
            <div
              class="summary-grid"
              style="grid-template-columns: repeat(3, 1fr)"
            >
              <div class="summary-item">
                <h3>Weighted Population</h3>
                <div class="summary-value" id="summary-weighted-population">
                  0
                </div>
              </div>
              <div class="summary-item">
                <h3>Maximum Annual Funding</h3>
                <div class="summary-value" id="summary-max-annual-funding">
                  £0
                </div>
              </div>
              <div class="summary-item">
                <h3>Maximum Monthly Funding</h3>
                <div class="summary-value" id="summary-max-monthly-funding">
                  £0
                </div>
              </div>
            </div>
            <div
              class="utilization-container"
              style="margin-top: 20px"
              id="arrs-utilization-container"
            >
              <h3>ARRS Utilization</h3>
              <div
                class="progress-container"
                style="
                  background-color: #f0f0f0;
                  height: 20px;
                  border-radius: 10px;
                  margin-top: 10px;
                  overflow: hidden;
                "
              >
                <div
                  id="arrs-progress-bar-summary"
                  style="
                    height: 100%;
                    background-color: var(--primary-color);
                    width: 0%;
                    transition: width 0.5s ease;
                  "
                ></div>
              </div>
              <div
                style="
                  display: flex;
                  justify-content: space-between;
                  margin-top: 5px;
                "
              >
                <span>0%</span>
                <span id="arrs-utilization-percentage-summary">0%</span>
                <span>100%</span>
              </div>
            </div>
            <button
              id="go-to-finance-tab"
              class="primary"
              style="margin-top: 15px"
            >
              <i class="fas fa-calculator"></i> Update Financial Entitlements
            </button>
          </div>

          <div class="card">
            <h2>Add Staff Member</h2>
            <div class="form-grid">
              <div class="form-group">
                <label for="staff-name">Staff Name/Description</label>
                <input
                  type="text"
                  id="staff-name"
                  placeholder="e.g. Clinical Pharmacist 1"
                />
              </div>
              <div class="form-group">
                <label for="role-type">Role Type</label>
                <select id="role-type">
                  <option value="">Select role...</option>
                  <option value="clinical-pharmacist">
                    Clinical Pharmacist
                  </option>
                  <option value="pharmacy-technician">
                    Pharmacy Technician
                  </option>
                  <option value="social-prescriber">
                    Social Prescribing Link Worker
                  </option>
                  <option value="health-wellbeing-coach">
                    Health & Wellbeing Coach
                  </option>
                  <option value="care-coordinator">Care Coordinator</option>
                  <option value="physician-associate">
                    Physician Associate
                  </option>
                  <option value="first-contact-physio">
                    First Contact Physiotherapist
                  </option>
                  <option value="dietitian">Dietitian</option>
                  <option value="podiatrist">Podiatrist</option>
                  <option value="occupational-therapist">
                    Occupational Therapist
                  </option>
                  <option value="trainee-nursing-associate">
                    Student Nursing Associate
                  </option>
                  <option value="nursing-associate">Nursing Associate</option>
                  <option value="paramedic">Paramedic</option>
                  <option value="advanced-practitioner">
                    Advanced Practitioner
                  </option>
                  <option value="gp-assistant">
                    General Practice Assistant
                  </option>
                  <option value="digital-lead">
                    Digital & Transformation Lead
                  </option>
                  <option value="apprentice-pa">
                    Apprentice Physician Associate
                  </option>
                  <option value="enhanced-practice-nurse">
                    Enhanced Practice Nurse
                  </option>
                  <option value="healthcare-support-worker">
                    Healthcare Support Worker
                  </option>
                  <option value="new-practice-nurse">
                    New to General Practice Nurse
                  </option>
                  <option value="experienced-practice-nurse">
                    Experienced General Practice Nurse
                  </option>
                  <option value="consultant-nurse">
                    Consultant Nurse Primary Care
                  </option>
                  <option value="mental-health-5050">
                    Mental Health Practitioner (50/50)
                  </option>
                  <option value="mental-health-100">
                    Mental Health Practitioner (100%)
                  </option>
                  <option value="gp">General Medical Practitioner</option>
                </select>
              </div>
              <div class="form-group">
                <label for="band">Band</label>
                <select id="band">
                  <option value="">Select band...</option>
                </select>
              </div>
              <div class="form-group">
                <label for="location">Location</label>
                <select id="location">
                  <option value="national">National</option>
                  <option value="inner-london">Inner London</option>
                  <option value="outer-london">Outer London</option>
                </select>
              </div>
              <div class="form-group">
                <label for="experience">Experience Level</label>
                <select id="experience">
                  <option value="entry">Entry Point</option>
                  <option value="mid" selected>Mid Point</option>
                  <option value="max">Maximum Point</option>
                </select>
              </div>
              <div class="form-group">
                <label for="wte">WTE (0.1-1.0)</label>
                <input
                  type="number"
                  id="wte"
                  min="0.1"
                  max="1"
                  step="0.1"
                  value="1"
                />
              </div>
              <div class="form-group">
                <label for="start-date">Start Date</label>
                <input type="date" id="start-date" />
              </div>
              <div class="form-group">
                <label for="last-pay-increase">Date of Last Pay Increase</label>
                <input type="date" id="last-pay-increase" />
              </div>
              <div class="form-group">
                <label for="salary-override">Salary Override (Optional)</label>
                <input
                  type="number"
                  id="salary-override"
                  placeholder="Leave blank for AfC rates"
                />
              </div>
            </div>
            <div class="form-actions">
              <button id="add-staff" class="primary">
                <i class="fas fa-user-plus"></i> Add Staff Member
              </button>
              <button id="clear-form" class="secondary">
                <i class="fas fa-eraser"></i> Clear Form
              </button>
            </div>
          </div>

          <div class="card">
            <h2>Staff Entries</h2>
            <div id="staff-entries">
              <div class="note">
                No staff members added yet. Use the form above to add staff.
              </div>
            </div>
          </div>

          <div class="card summary-card">
            <h2>
              PCN ARRS Summary
              <span class="location-display" id="location-display"
                >Location: National</span
              >
            </h2>
            <div class="summary-grid">
              <div class="summary-item">
                <h3>Total Annual Salary Costs</h3>
                <div class="summary-value" id="total-salary">£0</div>
              </div>
              <div class="summary-item">
                <h3>Total Employer NI</h3>
                <div class="summary-value" id="total-ni">£0</div>
              </div>
              <div class="summary-item">
                <h3>Total Employer Pension</h3>
                <div class="summary-value" id="total-pension">£0</div>
              </div>
              <div class="summary-item">
                <h3>Total Employment Costs</h3>
                <div class="summary-value" id="total-cost">£0</div>
              </div>
              <div class="summary-item">
                <h3>Maximum ARRS Funding</h3>
                <div class="summary-value" id="total-reimbursable">£0</div>
              </div>
              <div class="summary-item">
                <h3>Funding Gap/Surplus</h3>
                <div class="summary-value" id="funding-gap">£0</div>
              </div>
              <div class="summary-item">
                <h3>Total WTE</h3>
                <div class="summary-value" id="total-wte">0</div>
              </div>
            </div>
            <div
              class="note"
              style="font-size: 0.9em; margin-top: 15px; display: none"
              id="funding-note"
            >
              Maximum ARRS funding is calculated from the weighted population in
              the Financial Calculator tab. Enter your weighted population there
              for an accurate calculation.
            </div>
            <div
              class="funding-reallocation"
              style="margin-top: 20px; display: none"
              id="funding-reallocation-section"
            >
              <h3>Funding Reallocation Options</h3>
              <p>
                Your PCN has an ARRS funding gap of
                <strong id="funding-gap-amount">£0</strong>. Would you like to
                reallocate from other funding streams?
              </p>
              <div style="margin-top: 10px">
                <div class="checkbox-container">
                  <input
                    type="checkbox"
                    id="use-core-funding"
                    class="funding-source"
                  />
                  <label for="use-core-funding"
                    >Core PCN Funding (<span id="core-pcn-available">£0</span>
                    available)</label
                  >
                </div>
                <div class="checkbox-container">
                  <input
                    type="checkbox"
                    id="use-capacity-access"
                    class="funding-source"
                  />
                  <label for="use-capacity-access"
                    >Capacity and Access Support Payment (<span
                      id="capacity-access-available"
                      >£0</span
                    >
                    available)</label
                  >
                </div>
                <div class="checkbox-container">
                  <input type="checkbox" id="use-iif" class="funding-source" />
                  <label for="use-iif"
                    >Investment and Impact Fund (IIF) (<span id="iif-available"
                      >£0</span
                    >
                    available)</label
                  >
                </div>
                <div class="checkbox-container">
                  <input
                    type="checkbox"
                    id="use-care-home"
                    class="funding-source"
                  />
                  <label for="use-care-home"
                    >Care Home Premium (<span id="care-home-available">£0</span>
                    available)</label
                  >
                </div>
                <div class="checkbox-container">
                  <input
                    type="checkbox"
                    id="use-enhanced-access"
                    class="funding-source"
                  />
                  <label for="use-enhanced-access"
                    >Enhanced Access Payment (<span
                      id="enhanced-access-available"
                      >£0</span
                    >
                    available)</label
                  >
                </div>
              </div>
              <button
                id="apply-reallocation"
                class="primary"
                style="margin-top: 15px"
              >
                <i class="fas fa-sync-alt"></i> Apply Reallocation
              </button>
              <div class="note" style="margin-top: 10px">
                <strong>Note:</strong> Reallocating funding from other streams
                may impact service delivery in those areas. Consider the
                implications carefully before proceeding.
              </div>
            </div>
          </div>
        </div>

        <div class="tab-content" data-tab="monthly">
          <div class="card">
            <h2>
              Monthly Salary Tracker
              <span class="location-display" id="monthly-location-display"
                >Location: National</span
              >
            </h2>

            <div class="note" style="margin-bottom: 20px">
              <p>
                This tracker shows monthly salary costs for each staff member
                and provides monthly totals for better cash flow planning.
              </p>
            </div>

            <div class="filter-controls" style="margin-bottom: 20px">
              <div
                style="
                  display: flex;
                  gap: 20px;
                  align-items: center;
                  flex-wrap: wrap;
                "
              >
                <div>
                  <label for="monthly-view-year">Financial Year:</label>
                  <select
                    id="monthly-view-year"
                    style="min-width: 150px; margin-left: 10px"
                  >
                    <!-- Dynamically populated by JavaScript -->
                  </select>
                </div>
                <div>
                  <label for="monthly-view-type">View Type:</label>
                  <select
                    id="monthly-view-type"
                    style="min-width: 150px; margin-left: 10px"
                  >
                    <option value="salary">Basic Salary</option>
                    <option value="total">
                      Total Cost (inc. NI & Pension)
                    </option>
                    <option value="reimbursable">Reimbursable Amount</option>
                  </select>
                </div>
                <button id="update-monthly-view" class="primary">
                  <i class="fas fa-sync-alt"></i> Update View
                </button>
              </div>
            </div>

            <div class="month-grid-container" style="overflow-x: auto">
              <table
                id="monthly-tracker-table"
                style="width: 100%; border-collapse: collapse"
              >
                <thead>
                  <tr>
                    <th style="min-width: 200px">Staff Member</th>
                    <th>Apr</th>
                    <th>May</th>
                    <th>Jun</th>
                    <th>Jul</th>
                    <th>Aug</th>
                    <th>Sep</th>
                    <th>Oct</th>
                    <th>Nov</th>
                    <th>Dec</th>
                    <th>Jan</th>
                    <th>Feb</th>
                    <th>Mar</th>
                    <th>Annual Total</th>
                  </tr>
                </thead>
                <tbody id="monthly-tracker-body">
                  <!-- Filled dynamically by JavaScript -->
                </tbody>
                <tfoot>
                  <tr class="totals-row">
                    <td><strong>Monthly Totals</strong></td>
                    <td id="month-total-apr">£0</td>
                    <td id="month-total-may">£0</td>
                    <td id="month-total-jun">£0</td>
                    <td id="month-total-jul">£0</td>
                    <td id="month-total-aug">£0</td>
                    <td id="month-total-sep">£0</td>
                    <td id="month-total-oct">£0</td>
                    <td id="month-total-nov">£0</td>
                    <td id="month-total-dec">£0</td>
                    <td id="month-total-jan">£0</td>
                    <td id="month-total-feb">£0</td>
                    <td id="month-total-mar">£0</td>
                    <td id="month-total-annual">£0</td>
                  </tr>
                </tfoot>
              </table>
            </div>

            <div
              style="
                margin-top: 30px;
                display: flex;
                justify-content: space-between;
              "
            >
              <button id="export-monthly-csv" class="secondary">
                <i class="fas fa-file-csv"></i> Export Monthly Data to CSV
              </button>
              <div>
                <span style="margin-right: 10px; font-size: 0.9em; opacity: 0.8"
                  >Last updated:
                  <span id="monthly-last-updated">Never</span></span
                >
                <button id="update-monthly-btn" class="primary">
                  <i class="fas fa-sync-alt"></i> Refresh Data
                </button>
              </div>
            </div>
          </div>
        </div>

        <div class="tab-content" data-tab="forecast">
          <div class="card">
            <h2>
              ARRS Forecast
              <span class="location-display" id="forecast-location-display"
                >Location: National</span
              >
            </h2>

            <div class="note" style="margin-bottom: 20px">
              <p>
                Plan your PCN workforce and budget for the next financial year.
                Create forecasts with different scenarios to help with strategic
                planning.
              </p>
            </div>

            <div class="filter-controls" style="margin-bottom: 20px">
              <div
                style="
                  display: flex;
                  gap: 20px;
                  align-items: center;
                  flex-wrap: wrap;
                "
              >
                <div>
                  <label for="forecast-year">Financial Year:</label>
                  <select
                    id="forecast-year"
                    style="min-width: 150px; margin-left: 10px"
                  >
                    <!-- Dynamically populated by JavaScript -->
                  </select>
                </div>
                <div>
                  <label for="forecast-scenario">Scenario:</label>
                  <select
                    id="forecast-scenario"
                    style="min-width: 200px; margin-left: 10px"
                  >
                    <option value="current">Current Staff Only</option>
                    <option value="growth">Growth (Add New Staff)</option>
                    <option value="reduction">Reduction (Remove Staff)</option>
                  </select>
                </div>
                <button id="update-forecast" class="primary">
                  <i class="fas fa-sync-alt"></i> Update Forecast
                </button>
              </div>
            </div>

            <div id="forecast-settings" style="margin-bottom: 20px">
              <div class="card" style="margin-bottom: 20px">
                <h3>Forecast Settings</h3>

                <div
                  style="
                    display: grid;
                    grid-template-columns: 1fr 1fr;
                    gap: 20px;
                  "
                >
                  <div>
                    <h4>Financial Assumptions</h4>
                    <div class="form-group">
                      <label for="forecast-salary-increase"
                        >Annual Salary Increase:</label
                      >
                      <div style="display: flex; align-items: center">
                        <input
                          type="number"
                          id="forecast-salary-increase"
                          min="0"
                          max="20"
                          step="0.1"
                          value="3.5"
                          style="max-width: 100px"
                        />
                        <span style="margin-left: 10px">%</span>
                      </div>
                    </div>
                    <div class="form-group" style="margin-top: 10px">
                      <label for="forecast-arrs-increase"
                        >ARRS Funding Increase:</label
                      >
                      <div style="display: flex; align-items: center">
                        <input
                          type="number"
                          id="forecast-arrs-increase"
                          min="0"
                          max="15"
                          step="0.1"
                          value="5.0"
                          style="max-width: 100px"
                        />
                        <span style="margin-left: 10px">%</span>
                      </div>
                    </div>
                  </div>

                  <div id="forecast-growth-options" style="display: none">
                    <h4>Growth Options</h4>
                    <div class="form-group">
                      <label for="forecast-growth-staff"
                        >New Staff to Add:</label
                      >
                      <input
                        type="number"
                        id="forecast-growth-staff"
                        min="1"
                        max="20"
                        value="2"
                        style="max-width: 100px"
                      />
                    </div>
                  </div>

                  <div id="forecast-reduction-options" style="display: none">
                    <h4>Reduction Options</h4>
                    <div class="checkbox-container">
                      <input
                        type="checkbox"
                        id="forecast-reduction-natural"
                        checked
                      />
                      <label for="forecast-reduction-natural"
                        >Natural Attrition Only</label
                      >
                    </div>
                    <div class="form-group" style="margin-top: 10px">
                      <label for="forecast-reduction-percent"
                        >Reduction Target:</label
                      >
                      <div style="display: flex; align-items: center">
                        <input
                          type="number"
                          id="forecast-reduction-percent"
                          min="5"
                          max="50"
                          value="10"
                          style="max-width: 100px"
                        />
                        <span style="margin-left: 10px">%</span>
                      </div>
                    </div>
                  </div>
                </div>

                <div
                  style="
                    margin-top: 15px;
                    display: flex;
                    justify-content: flex-end;
                  "
                >
                  <button id="apply-forecast-settings" class="primary">
                    <i class="fas fa-check"></i> Apply Settings
                  </button>
                </div>
              </div>
            </div>

            <div id="forecast-results">
              <h3>Forecast Results</h3>

              <div class="card" style="margin-top: 15px">
                <h4>Summary Comparison</h4>
                <table style="width: 100%">
                  <thead>
                    <tr>
                      <th>Metric</th>
                      <th>Current Year</th>
                      <th>Forecast Year</th>
                      <th>Change</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr>
                      <td>Total Staff</td>
                      <td id="forecast-current-staff">-</td>
                      <td id="forecast-future-staff">-</td>
                      <td id="forecast-change-staff">-</td>
                    </tr>
                    <tr>
                      <td>Total WTE</td>
                      <td id="forecast-current-wte">-</td>
                      <td id="forecast-future-wte">-</td>
                      <td id="forecast-change-wte">-</td>
                    </tr>
                    <tr>
                      <td>Annual Salary Costs</td>
                      <td id="forecast-current-salary">-</td>
                      <td id="forecast-future-salary">-</td>
                      <td id="forecast-change-salary">-</td>
                    </tr>
                    <tr>
                      <td>Total Employment Costs</td>
                      <td id="forecast-current-total">-</td>
                      <td id="forecast-future-total">-</td>
                      <td id="forecast-change-total">-</td>
                    </tr>
                    <tr>
                      <td>Maximum ARRS Funding</td>
                      <td id="forecast-current-funding">-</td>
                      <td id="forecast-future-funding">-</td>
                      <td id="forecast-change-funding">-</td>
                    </tr>
                    <tr>
                      <td>Funding Gap/Surplus</td>
                      <td id="forecast-current-gap">-</td>
                      <td id="forecast-future-gap">-</td>
                      <td id="forecast-change-gap">-</td>
                    </tr>
                  </tbody>
                </table>
              </div>

              <div style="margin-top: 20px">
                <h4>Detailed Staff Forecast</h4>
                <div style="overflow-x: auto; margin-top: 10px">
                  <table id="forecast-staff-table" style="width: 100%">
                    <thead>
                      <tr>
                        <th style="min-width: 200px">Staff Member</th>
                        <th>Current Salary</th>
                        <th>Forecast Salary</th>
                        <th>Current Total Cost</th>
                        <th>Forecast Total Cost</th>
                        <th>Change</th>
                      </tr>
                    </thead>
                    <tbody id="forecast-staff-body">
                      <!-- Filled dynamically by JavaScript -->
                    </tbody>
                  </table>
                </div>
              </div>
            </div>

            <div
              style="
                margin-top: 30px;
                display: flex;
                justify-content: space-between;
              "
            >
              <button id="export-forecast-csv" class="secondary">
                <i class="fas fa-file-csv"></i> Export Forecast to CSV
              </button>
              <div>
                <button id="save-forecast" class="primary">
                  <i class="fas fa-save"></i> Save Forecast Scenario
                </button>
              </div>
            </div>
          </div>
        </div>

        <div class="tab-content" data-tab="bandings">
          <div class="card">
            <h2>
              ARRS Role Salary Bandings
              <span class="location-display" id="bandings-location-display"
                >Location: National</span
              >
            </h2>
            <div class="location-selector" style="margin-bottom: 20px">
              <label for="bandings-location">Select Location:</label>
              <select id="bandings-location" style="max-width: 200px">
                <option value="national">National</option>
                <option value="inner-london">Inner London</option>
                <option value="outer-london">Outer London</option>
              </select>
              <button
                id="update-bandings-btn"
                class="primary"
                style="margin-left: 10px"
              >
                <i class="fas fa-sync-alt"></i> Update
              </button>
            </div>

            <div class="note" style="margin-bottom: 20px">
              <p>
                The table below shows the maximum reimbursable amounts for each
                ARRS role based on the selected location.
              </p>
              <p>
                For mental health practitioners, reimbursement varies by AfC
                band and funding model (50/50 or 100%).
              </p>
            </div>

            <div class="filter-controls" style="margin-bottom: 15px">
              <label>Filter by AfC band:</label>
              <div class="band-filters" style="margin-top: 5px">
                <button class="band-filter active" data-band="all">
                  All Bands
                </button>
                <button class="band-filter" data-band="3">Band 3</button>
                <button class="band-filter" data-band="4">Band 4</button>
                <button class="band-filter" data-band="5">Band 5</button>
                <button class="band-filter" data-band="6">Band 6</button>
                <button class="band-filter" data-band="7">Band 7</button>
                <button class="band-filter" data-band="8a">Band 8a</button>
                <button class="band-filter" data-band="8c">Band 8c</button>
              </div>
            </div>

            <table id="arrs-bandings-table">
              <thead>
                <tr>
                  <th>Role</th>
                  <th>AfC Band</th>
                  <th>Maximum Reimbursable (Annual)</th>
                  <th>Maximum Reimbursable (Monthly)</th>
                  <th>Entry Point</th>
                  <th>Mid Point</th>
                  <th>Maximum Point</th>
                </tr>
              </thead>
              <tbody id="arrs-bandings-body">
                <!-- Filled dynamically by JavaScript -->
              </tbody>
            </table>

            <div style="margin-top: 30px">
              <h3>AfC Pay Scales (2025-26 Estimated)</h3>
              <table>
                <thead>
                  <tr>
                    <th>AfC Band</th>
                    <th>Entry Point</th>
                    <th>Mid Point</th>
                    <th>Maximum Point</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td>Band 3</td>
                    <td id="band-3-entry">£23,949</td>
                    <td id="band-3-mid">£26,000</td>
                    <td id="band-3-max">£28,071</td>
                  </tr>
                  <tr>
                    <td>Band 4</td>
                    <td id="band-4-entry">£25,655</td>
                    <td id="band-4-mid">£28,000</td>
                    <td id="band-4-max">£30,615</td>
                  </tr>
                  <tr>
                    <td>Band 5</td>
                    <td id="band-5-entry">£28,407</td>
                    <td id="band-5-mid">£32,000</td>
                    <td id="band-5-max">£34,581</td>
                  </tr>
                  <tr>
                    <td>Band 6</td>
                    <td id="band-6-entry">£35,392</td>
                    <td id="band-6-mid">£38,000</td>
                    <td id="band-6-max">£40,588</td>
                  </tr>
                  <tr>
                    <td>Band 7</td>
                    <td id="band-7-entry">£42,121</td>
                    <td id="band-7-mid">£46,000</td>
                    <td id="band-7-max">£48,246</td>
                  </tr>
                  <tr>
                    <td>Band 8a</td>
                    <td id="band-8a-entry">£49,217</td>
                    <td id="band-8a-mid">£53,000</td>
                    <td id="band-8a-max">£56,166</td>
                  </tr>
                  <tr>
                    <td>Band 8c</td>
                    <td id="band-8c-entry">£67,064</td>
                    <td id="band-8c-mid">£73,000</td>
                    <td id="band-8c-max">£78,192</td>
                  </tr>
                  <tr>
                    <td>GP Scale</td>
                    <td id="band-gp-entry">£75,000</td>
                    <td id="band-gp-mid">£85,000</td>
                    <td id="band-gp-max">£95,000</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <div class="tab-content" data-tab="comparison">
          <div class="card">
            <h2>ARRS Funding Comparison</h2>
            <div class="note" style="margin-bottom: 20px">
              This comparison shows how your planned ARRS roles compare to your
              maximum ARRS entitlement based on your weighted population.
            </div>

            <div class="form-row">
              <div class="form-col">
                <h3>Workforce Summary</h3>
                <div
                  class="summary-grid"
                  style="grid-template-columns: repeat(2, 1fr)"
                >
                  <div class="summary-item">
                    <h4>Total WTE</h4>
                    <div class="summary-value" id="comparison-total-wte">0</div>
                  </div>
                  <div class="summary-item">
                    <h4>Total Staff</h4>
                    <div class="summary-value" id="comparison-total-staff">
                      0
                    </div>
                  </div>
                </div>
              </div>
              <div class="form-col">
                <h3>Funding Details</h3>
                <div
                  class="summary-grid"
                  style="grid-template-columns: repeat(2, 1fr)"
                >
                  <div class="summary-item">
                    <h4>Weighted Population</h4>
                    <div
                      class="summary-value"
                      id="comparison-weighted-population"
                    >
                      0
                    </div>
                  </div>
                  <div class="summary-item">
                    <h4>ARRS Rate</h4>
                    <div class="summary-value">£26.631 per patient</div>
                  </div>
                </div>
              </div>
            </div>

            <table style="margin-top: 30px">
              <thead>
                <tr>
                  <th>ARRS Funding</th>
                  <th>Annual Amount (£)</th>
                  <th>Monthly Amount (£)</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td>Maximum ARRS Entitlement</td>
                  <td id="comparison-max-arrs-annual">£0</td>
                  <td id="comparison-max-arrs-monthly">£0</td>
                </tr>
                <tr>
                  <td>Current Planned ARRS Expenditure</td>
                  <td id="comparison-current-arrs-annual">£0</td>
                  <td id="comparison-current-arrs-monthly">£0</td>
                </tr>
                <tr class="totals-row" id="comparison-arrs-balance-row">
                  <td><strong>Remaining ARRS Funding</strong></td>
                  <td id="comparison-remaining-arrs-annual">
                    <strong>£0</strong>
                  </td>
                  <td id="comparison-remaining-arrs-monthly">
                    <strong>£0</strong>
                  </td>
                </tr>
              </tbody>
            </table>

            <div class="arrs-utilization" style="margin-top: 30px">
              <h3>ARRS Funding Utilization</h3>
              <div
                class="progress-container"
                style="
                  background-color: #f0f0f0;
                  height: 25px;
                  border-radius: 12px;
                  margin-top: 15px;
                  overflow: hidden;
                "
              >
                <div
                  id="comparison-arrs-progress-bar"
                  style="
                    height: 100%;
                    background-color: var(--primary-color);
                    width: 0%;
                    transition: width 0.5s ease;
                  "
                ></div>
              </div>
              <div
                style="
                  display: flex;
                  justify-content: space-between;
                  margin-top: 8px;
                  font-weight: bold;
                "
              >
                <span>0%</span>
                <span id="comparison-arrs-utilization-percentage">0%</span>
                <span>100%</span>
              </div>
            </div>

            <div
              style="
                margin-top: 30px;
                display: flex;
                justify-content: space-between;
                align-items: center;
              "
            >
              <div>
                <button id="update-comparison-btn" class="primary">
                  <i class="fas fa-sync-alt"></i> Update Comparison
                </button>
                <span style="margin-left: 15px; font-size: 0.9em; opacity: 0.8"
                  >Last updated:
                  <span id="comparison-last-updated">Never</span></span
                >
              </div>
              <div>
                <button
                  id="go-to-finance-tab-from-comparison"
                  class="secondary"
                >
                  <i class="fas fa-calculator"></i> Update Weighted Population
                </button>
              </div>
            </div>
          </div>
        </div>

        <div class="tab-content" data-tab="data">
          <div class="card">
            <h2>Save and Load Data</h2>
            <p>
              Your data is automatically saved in your browser. You can also
              manually backup, export, or import your data.
            </p>

            <div class="controls">
              <button id="export-csv">
                <i class="fas fa-file-csv"></i> Export to CSV
              </button>
              <button id="export-pdf">
                <i class="fas fa-file-pdf"></i> Export to PDF
              </button>
              <button id="export-json" class="secondary">
                <i class="fas fa-file-code"></i> Export to JSON
              </button>
              <button id="save-data" class="secondary">
                <i class="fas fa-save"></i> Save Data
              </button>
              <button id="clear-data" class="remove">
                <i class="fas fa-trash-alt"></i> Clear All Data
              </button>
            </div>

            <h3>Backup/Restore Data</h3>
            <p>
              Copy the text below to backup your data, or paste previously saved
              data to restore.
            </p>
            <textarea class="backup-area" id="backup-area"></textarea>
            <div class="controls">
              <button id="copy-backup">
                <i class="fas fa-copy"></i> Copy Data
              </button>
              <button id="restore-backup">
                <i class="fas fa-upload"></i> Restore from Text
              </button>
            </div>
          </div>
        </div>

        <div class="tab-content" data-tab="finance">
          <div class="card">
            <h2>Calculate Your 2025-26 Financial Entitlements</h2>

            <div class="form-row">
              <div class="form-col">
                <label for="raw-list-size"
                  >Raw List Size (as at 1 January 2025):</label
                >
                <input
                  type="number"
                  id="raw-list-size"
                  placeholder="Enter PCN raw list size"
                  required
                />
              </div>
              <div class="form-col">
                <label for="adjusted-population"
                  >Adjusted Population (as at 1 January 2025):</label
                >
                <input
                  type="number"
                  id="adjusted-population"
                  placeholder="Enter PCN adjusted population"
                  required
                />
              </div>
            </div>

            <div>
              <label for="care-home-beds">Number of Care Home Beds:</label>
              <input type="number" id="care-home-beds" value="0" min="0" />
            </div>

            <div>
              <label for="weighted-population"
                >Weighted Population (for ARRS calculation):</label
              >
              <input
                type="number"
                id="weighted-population"
                placeholder="Enter weighted population for ARRS"
                min="0"
              />
            </div>

            <div class="note" style="margin-top: 10px; margin-bottom: 20px">
              <p>
                If you've already added staff in the ARRS Calculator tab, this
                calculator will automatically compare your planned staff costs
                with your ARRS entitlement when you click Calculate.
              </p>
            </div>

            <div>
              <h3 style="margin-top: 15px">Payment Achievement Options</h3>

              <div>
                <label for="iif-points"
                  >Investment and Impact Fund (IIF) Points Expected to
                  Achieve:</label
                >
                <input
                  type="number"
                  id="iif-points"
                  min="0"
                  max="58"
                  value="58"
                  step="1"
                  style="max-width: 200px"
                />
                <div class="note" style="margin-top: 5px; padding: 5px">
                  Maximum available: 58 points at £198 per point
                </div>
              </div>

              <div style="margin-top: 20px">
                <label
                  >Local Capacity and Access Improvement Payment (CAIP) Elements
                  Achieved:</label
                >
                <div class="checkbox-container">
                  <input
                    type="checkbox"
                    id="caip-risk-stratification"
                    checked
                  />
                  <label for="caip-risk-stratification"
                    >Risk Stratification to Support Continuity of Care (1/3 of
                    payment)</label
                  >
                </div>
                <div class="checkbox-container">
                  <input type="checkbox" id="caip-modern-access" checked />
                  <label for="caip-modern-access"
                    >Supporting Modern General Practice Access (2/3 of
                    payment)</label
                  >
                </div>
                <div style="margin-top: 10px">
                  <label for="caip-achievement-month"
                    >Expected Month of CAIP Achievement:</label
                  >
                  <select id="caip-achievement-month" style="max-width: 200px">
                    <option value="4">April 2025</option>
                    <option value="5">May 2025</option>
                    <option value="6">June 2025</option>
                    <option value="7">July 2025</option>
                    <option value="8">August 2025</option>
                    <option value="9">September 2025</option>
                    <option value="10">October 2025</option>
                    <option value="11">November 2025</option>
                    <option value="12">December 2025</option>
                    <option value="1">January 2026</option>
                    <option value="2">February 2026</option>
                    <option value="3">March 2026</option>
                  </select>
                </div>
              </div>
            </div>

            <div class="form-actions" style="margin-top: 20px">
              <button id="calculate-finance-btn" class="primary">
                <i class="fas fa-calculator"></i> Calculate Entitlements
              </button>
              <button id="save-finance-btn" class="secondary">
                <i class="fas fa-save"></i> Save Entitlements
              </button>
              <button id="reset-finance-btn" class="secondary">
                <i class="fas fa-undo"></i> Reset
              </button>
            </div>
          </div>

          <div class="card" id="finance-results-section" style="display: none">
            <h2>Financial Entitlements Results</h2>

            <table>
              <thead>
                <tr>
                  <th>Payment Type</th>
                  <th>Rate per Patient/Bed (£)</th>
                  <th>Annual Amount (£)</th>
                  <th>Monthly Amount (£)</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td>Core PCN Funding</td>
                  <td>£2.999 per patient</td>
                  <td id="core-pcn-funding-annual">-</td>
                  <td id="core-pcn-funding-monthly">-</td>
                </tr>
                <tr>
                  <td>Enhanced Access Payment</td>
                  <td>£8.427 per adjusted patient</td>
                  <td id="enhanced-access-annual">-</td>
                  <td id="enhanced-access-monthly">-</td>
                </tr>
                <tr>
                  <td>Care Home Premium</td>
                  <td>
                    £130.253 per bed annually<br />£10.8544 per bed monthly
                  </td>
                  <td id="care-home-premium-annual">-</td>
                  <td id="care-home-premium-monthly">-</td>
                </tr>
                <tr>
                  <td>Capacity and Access Support Payment</td>
                  <td>£3.208 per adjusted patient</td>
                  <td id="capacity-access-annual">-</td>
                  <td id="capacity-access-monthly">-</td>
                </tr>
                <tr>
                  <td>Local Capacity and Access Improvement Payment (CAIP)</td>
                  <td>£1.375 per adjusted patient</td>
                  <td id="caip-annual">-</td>
                  <td id="caip-monthly">-</td>
                </tr>
                <tr>
                  <td>Investment and Impact Fund (IIF)</td>
                  <td>Maximum: £198 per point (58 points)</td>
                  <td id="iif-annual">-</td>
                  <td id="iif-monthly">-</td>
                </tr>
                <tr>
                  <td>Additional Roles Reimbursement Sum</td>
                  <td>£26.631 per weighted population patient</td>
                  <td id="arrs-annual">-</td>
                  <td id="arrs-monthly">-</td>
                </tr>
                <tr class="totals-row">
                  <td><strong>Total (excluding Additional Roles)</strong></td>
                  <td>-</td>
                  <td id="subtotal-annual"><strong>-</strong></td>
                  <td id="subtotal-monthly"><strong>-</strong></td>
                </tr>
                <tr class="totals-row">
                  <td>
                    <strong>Grand Total (including Additional Roles)</strong>
                  </td>
                  <td>-</td>
                  <td id="total-annual"><strong>-</strong></td>
                  <td id="total-monthly"><strong>-</strong></td>
                </tr>
              </tbody>
            </table>

            <!-- Link to ARRS Comparison Tab -->
            <div style="margin-top: 30px; text-align: center">
              <p>
                To see how your ARRS staffing compares with your maximum
                entitlement, visit the ARRS Comparison tab.
              </p>
              <button
                id="go-to-comparison-btn"
                class="primary"
                style="margin-top: 15px"
              >
                <i class="fas fa-chart-pie"></i> View ARRS Comparison
              </button>
            </div>

            <div class="note">
              <p><strong>Notes:</strong></p>
              <p>
                * The Core PCN Funding is calculated as £2.266 per raw list
                patient plus £0.733 per adjusted population patient.
              </p>
              <p>
                * The Additional Roles Reimbursement Sum is calculated using the
                PCN's Weighted Population at a rate of £26.631 per patient.
              </p>
              <p>
                * Local Capacity and Access Improvement Payment (CAIP) has two
                elements: Risk Stratification to Support Continuity of Care (1/3
                of payment) and Supporting Modern General Practice Access (2/3
                of payment). CAIP payments begin from the month when achievement
                is declared and are spread over the remaining months of the
                financial year.
              </p>
              <p>
                * Investment and Impact Fund (IIF) shows payment based on the
                number of points you expect to achieve, at a rate of £198 per
                point, with a maximum of 58 points available. IIF is paid as a
                single annual payment, not monthly installments.
              </p>
            </div>
          </div>
        </div>

        <div class="tab-content" data-tab="about">
          <div class="card">
            <h2>About This Calculator</h2>
            <p>
              This calculator helps Primary Care Networks (PCNs) plan their
              workforce and calculate salary costs and reimbursement amounts
              under the Network Contract Directed Enhanced Service (DES)
              2025-2026.
            </p>

            <h3>Features</h3>
            <ul>
              <li>
                Plan your PCN workforce with accurate salary and reimbursement
                information
              </li>
              <li>
                Includes all ARRS roles with correct maximum reimbursable
                amounts
              </li>
              <li>Automatically calculates employer costs (NI and pension)</li>
              <li>
                Supports different location allowances (National, Inner London,
                Outer London)
              </li>
              <li>Calculate your full PCN DES financial entitlements</li>
              <li>Data is saved in your browser automatically</li>
              <li>
                Multiple export options:
                <ul>
                  <li>CSV format for importing to spreadsheets</li>
                  <li>PDF format for printing and formal reporting</li>
                  <li>JSON format for system integration and data backup</li>
                </ul>
              </li>
              <li>
                Reference information for ARRS role bandings and salary scales
              </li>
              <li>Full budget comparison with funding gap/surplus analysis</li>
            </ul>

            <h3>Data Usage</h3>
            <p>
              All data is stored locally in your browser using localStorage. No
              data is sent to any server. Clearing your browser cache or using
              private browsing may delete your saved data.
            </p>

            <h3>How to Use</h3>
            <ol>
              <li>Use the "ARRS Calculator" tab to plan your workforce</li>
              <li>
                Use the "Financial Calculator" tab to calculate your PCN's DES
                payments
              </li>
              <li>
                The calculator will show if the role is within the maximum
                reimbursable amount
              </li>
              <li>
                View your total PCN costs and funding position in the summary
                section
              </li>
              <li>Use the Data Management tab to backup or export your data</li>
            </ol>

            <h3>Notes</h3>
            <ul>
              <li>
                Salary calculations use estimated Agenda for Change (AfC)
                mid-points
              </li>
              <li>Employer NI is calculated at 13.8% above the NI threshold</li>
              <li>Employer Pension contribution is calculated at 20.6%</li>
              <li>
                Maximum reimbursable amounts are based on the 2025-26 Network
                Contract DES specification
              </li>
              <li>Financial calculator uses 2025-26 DES payment rates</li>
            </ul>
          </div>
        </div>
      </div>
    </div>

    <footer>
      <p>
        PCN ARRS Workforce Planning Calculator 2025-26 | Data based on Network
        Contract DES 2025-26
      </p>
      <p>
        All data is stored locally in your browser. No data is sent to any
        server.
      </p>
    </footer>

    <script>
      // Financial calculator parameters
      const financialParams = {
        // Core PCN Funding (split into raw list and adjusted population components)
        corePCNFundingRawListRate: 2.266,
        corePCNFundingAdjustedPopRate: 0.733,
        corePCNFundingCombinedRate: 2.999, // For display purposes

        // Other rates
        enhancedAccessPayment: 8.427,
        careHomePremiumAnnual: 130.253, // Annual rate per bed
        careHomePremiumMonthly: 10.8544, // Monthly rate per bed
        capacityAndAccessSupportPayment: 3.208,
        caipPayment: 1.375,
        arrsPayment: 26.631,

        // Investment and Impact Fund parameters
        iifPointValue: 198.0, // £198 per point
        iifTotalPoints: 58, // 58 total points available
      };

      // Data structure for reimbursable amounts based on Network Contract DES 2025-26
      const reimbursableAmounts = {
        "clinical-pharmacist": {
          national: 66972,
          "inner-london": 77545,
          "outer-london": 74392,
          bands: ["7", "8a"],
        },
        "pharmacy-technician": {
          national: 43352,
          "inner-london": 52172,
          "outer-london": 49967,
          bands: ["5"],
        },
        "social-prescriber": {
          national: 43352,
          "inner-london": 52172,
          "outer-london": 49967,
          bands: ["5"],
        },
        "health-wellbeing-coach": {
          national: 43352,
          "inner-london": 52172,
          "outer-london": 49967,
          bands: ["5"],
        },
        "care-coordinator": {
          national: 36150,
          "inner-london": 43529,
          "outer-london": 42038,
          bands: ["4"],
        },
        "physician-associate": {
          national: 64907,
          "inner-london": 75480,
          "outer-london": 72327,
          bands: ["7"],
        },
        "first-contact-physio": {
          national: 66972,
          "inner-london": 77545,
          "outer-london": 74392,
          bands: ["7", "8a"],
        },
        dietitian: {
          national: 64907,
          "inner-london": 75480,
          "outer-london": 72327,
          bands: ["7"],
        },
        podiatrist: {
          national: 64907,
          "inner-london": 75480,
          "outer-london": 72327,
          bands: ["7"],
        },
        "occupational-therapist": {
          national: 64907,
          "inner-london": 75480,
          "outer-london": 72327,
          bands: ["7"],
        },
        "trainee-nursing-associate": {
          national: 32159,
          "inner-london": 39164,
          "outer-london": 38047,
          bands: ["3"],
        },
        "nursing-associate": {
          national: 36150,
          "inner-london": 43529,
          "outer-london": 42038,
          bands: ["4"],
        },
        paramedic: {
          national: 64907,
          "inner-london": 75480,
          "outer-london": 72327,
          bands: ["7"],
        },
        "advanced-practitioner": {
          national: 73334,
          "inner-london": 83907,
          "outer-london": 80754,
          bands: ["8a"],
        },
        "gp-assistant": {
          national: 36150,
          "inner-london": 43529,
          "outer-london": 42038,
          bands: ["4"],
        },
        "digital-lead": {
          national: 73334,
          "inner-london": 83907,
          "outer-london": 80754,
          bands: ["8a"],
        },
        "apprentice-pa": {
          national: 43352,
          "inner-london": 52172,
          "outer-london": 49967,
          bands: ["5"],
        },
        "enhanced-practice-nurse": {
          national: 64907,
          "inner-london": 75480,
          "outer-london": 72327,
          bands: ["7"],
        },
        "healthcare-support-worker": {
          national: 32159,
          "inner-london": 39164,
          "outer-london": 38047,
          bands: ["3"],
        },
        "new-practice-nurse": {
          national: 43352,
          "inner-london": 52172,
          "outer-london": 49967,
          bands: ["5"],
        },
        "experienced-practice-nurse": {
          national: 53319,
          "inner-london": 63892,
          "outer-london": 60739,
          bands: ["6"],
        },
        "consultant-nurse": {
          national: 102683,
          "inner-london": 113256,
          "outer-london": 110103,
          bands: ["8c"],
        },
        "mental-health-5050": {
          4: {
            national: 18075,
            "inner-london": 21765,
            "outer-london": 21019,
          },
          5: {
            national: 21676,
            "inner-london": 26086,
            "outer-london": 24984,
          },
          6: {
            national: 26660,
            "inner-london": 31946,
            "outer-london": 30370,
          },
          7: {
            national: 32454,
            "inner-london": 37740,
            "outer-london": 36163,
          },
          "8a": {
            national: 36667,
            "inner-london": 41953,
            "outer-london": 40377,
          },
          bands: ["4", "5", "6", "7", "8a"],
        },
        "mental-health-100": {
          4: {
            national: 36150,
            "inner-london": 43529,
            "outer-london": 42038,
          },
          5: {
            national: 43352,
            "inner-london": 52172,
            "outer-london": 49967,
          },
          6: {
            national: 53319,
            "inner-london": 63892,
            "outer-london": 60739,
          },
          7: {
            national: 64907,
            "inner-london": 75480,
            "outer-london": 72327,
          },
          "8a": {
            national: 73334,
            "inner-london": 83907,
            "outer-london": 80754,
          },
          bands: ["4", "5", "6", "7", "8a"],
        },
        gp: {
          national: 105882,
          "inner-london": 108680,
          "outer-london": 108680,
          bands: ["gp"],
        },
      };

      // Agenda for Change pay scales (estimated mid-points)
      const afcBands = {
        3: {
          entry: 23949,
          mid: 26000,
          max: 28071,
        },
        4: {
          entry: 25655,
          mid: 28000,
          max: 30615,
        },
        5: {
          entry: 28407,
          mid: 32000,
          max: 34581,
        },
        6: {
          entry: 35392,
          mid: 38000,
          max: 40588,
        },
        7: {
          entry: 42121,
          mid: 46000,
          max: 48246,
        },
        "8a": {
          entry: 49217,
          mid: 53000,
          max: 56166,
        },
        "8c": {
          entry: 67064,
          mid: 73000,
          max: 78192,
        },
        gp: {
          entry: 75000,
          mid: 85000,
          max: 95000,
        },
      };

      // Role titles for display
      const roleTitles = {
        "clinical-pharmacist": "Clinical Pharmacist",
        "pharmacy-technician": "Pharmacy Technician",
        "social-prescriber": "Social Prescribing Link Worker",
        "health-wellbeing-coach": "Health & Wellbeing Coach",
        "care-coordinator": "Care Coordinator",
        "physician-associate": "Physician Associate",
        "first-contact-physio": "First Contact Physiotherapist",
        dietitian: "Dietitian",
        podiatrist: "Podiatrist",
        "occupational-therapist": "Occupational Therapist",
        "trainee-nursing-associate": "Student Nursing Associate",
        "nursing-associate": "Nursing Associate",
        paramedic: "Paramedic",
        "advanced-practitioner": "Advanced Practitioner",
        "gp-assistant": "General Practice Assistant",
        "digital-lead": "Digital & Transformation Lead",
        "apprentice-pa": "Apprentice Physician Associate",
        "enhanced-practice-nurse": "Enhanced Practice Nurse",
        "healthcare-support-worker": "Healthcare Support Worker",
        "new-practice-nurse": "New to General Practice Nurse",
        "experienced-practice-nurse": "Experienced General Practice Nurse",
        "consultant-nurse": "Consultant Nurse Primary Care",
        "mental-health-5050": "Mental Health Practitioner (50/50)",
        "mental-health-100": "Mental Health Practitioner (100%)",
        gp: "General Medical Practitioner",
      };

      // Variables
      let staffList = [];
      const NI_THRESHOLD = 9100; // Annual NI threshold
      const NI_RATE = 0.138; // 13.8%
      const PENSION_RATE = 0.206; // 20.6%

      // DOM Elements
      const roleSelect = document.getElementById("role-type");
      const bandSelect = document.getElementById("band");
      const locationSelect = document.getElementById("location");
      const experienceSelect = document.getElementById("experience");
      const wteInput = document.getElementById("wte");
      const staffNameInput = document.getElementById("staff-name");
      const startDateInput = document.getElementById("start-date");
      const salaryOverrideInput = document.getElementById("salary-override");
      const addStaffBtn = document.getElementById("add-staff");
      const clearFormBtn = document.getElementById("clear-form");
      const staffEntriesContainer = document.getElementById("staff-entries");
      const exportCsvBtn = document.getElementById("export-csv");
      const saveDataBtn = document.getElementById("save-data");
      const clearDataBtn = document.getElementById("clear-data");
      const backupArea = document.getElementById("backup-area");
      const copyBackupBtn = document.getElementById("copy-backup");
      const restoreBackupBtn = document.getElementById("restore-backup");

      // Tab elements
      const tabs = document.querySelectorAll(".tab");
      const tabContents = document.querySelectorAll(".tab-content");

      // Summary elements
      const totalSalaryEl = document.getElementById("total-salary");
      const totalNiEl = document.getElementById("total-ni");
      const totalPensionEl = document.getElementById("total-pension");
      const totalCostEl = document.getElementById("total-cost");
      const totalReimbursableEl = document.getElementById("total-reimbursable");
      const fundingGapEl = document.getElementById("funding-gap");
      const totalWteEl = document.getElementById("total-wte");

      // Initialize
      document.addEventListener("DOMContentLoaded", init);

      function init() {
        // Set default date to today
        const today = new Date();
        startDateInput.value = today.toISOString().split("T")[0];

        // Set last pay increase date to 1st April (start of financial year)
        const currentYear = today.getFullYear();
        const aprilFirst = new Date(currentYear, 3, 1); // Month is 0-indexed, so 3 = April
        document.getElementById("last-pay-increase").value = aprilFirst
          .toISOString()
          .split("T")[0];

        // Populate financial years for monthly tracker and forecast
        populateFinancialYears();
        populateForecastYears();

        // Event listeners
        roleSelect.addEventListener("change", updateBandOptions);
        locationSelect.addEventListener("change", updateLocationDisplay);
        addStaffBtn.addEventListener("click", addStaffMember);
        clearFormBtn.addEventListener("click", clearForm);
        exportCsvBtn.addEventListener("click", exportToCsv);
        document
          .getElementById("export-pdf")
          .addEventListener("click", exportToPdf);
        document
          .getElementById("export-json")
          .addEventListener("click", exportToJson);
        saveDataBtn.addEventListener("click", saveData);
        clearDataBtn.addEventListener("click", clearAllData);
        copyBackupBtn.addEventListener("click", copyBackupData);
        restoreBackupBtn.addEventListener("click", restoreBackupData);

        // Tab navigation
        tabs.forEach((tab) => {
          tab.addEventListener("click", () => {
            const tabId = tab.getAttribute("data-tab");
            setActiveTab(tabId);

            // If switching to data tab, update backup area
            if (tabId === "data") {
              backupArea.value = JSON.stringify(staffList, null, 2);
            }

            // If switching to ARRS calculator tab, update the summary
            if (tabId === "calculator") {
              updateSummary();

              // Check if weighted population is set in Financial calculator
              const weightedPopulation =
                parseFloat(
                  document.getElementById("weighted-population").value
                ) || 0;
              updateArrsEntitlementSummary(weightedPopulation);
            }
          });
        });

        // Load saved data
        loadData();

        // Initial update of band options
        updateBandOptions();

        // Initial update of location display
        updateLocationDisplay();

        // Financial entitlements event listeners
        document
          .getElementById("calculate-finance-btn")
          .addEventListener("click", calculateFinancialEntitlements);
        document
          .getElementById("save-finance-btn")
          .addEventListener("click", saveFinancialEntitlements);
        document
          .getElementById("reset-finance-btn")
          .addEventListener("click", resetFinanceCalculator);

        // Go to finance tab buttons
        document
          .getElementById("go-to-finance-tab")
          .addEventListener("click", function () {
            setActiveTab("finance");
            document.getElementById("weighted-population").focus();
          });

        document
          .getElementById("go-to-finance-tab-from-comparison")
          .addEventListener("click", function () {
            setActiveTab("finance");
            document.getElementById("weighted-population").focus();
          });

        // Go to comparison tab button
        document
          .getElementById("go-to-comparison-btn")
          .addEventListener("click", function () {
            setActiveTab("comparison");
          });

        // ARRS bandings tab event listeners
        document
          .getElementById("update-bandings-btn")
          .addEventListener("click", updateBandingsTable);
        document
          .getElementById("bandings-location")
          .addEventListener("change", function () {
            const location = this.value;

            // Update bandings location display
            document.getElementById("bandings-location-display").textContent =
              "Location: " +
              (location === "national"
                ? "National"
                : location === "inner-london"
                ? "Inner London"
                : "Outer London");

            // Sync with main calculator location
            locationSelect.value = location;
            updateLocationDisplay();

            // Update bandings table
            updateBandingsTable();
          });

        // Band filter buttons
        document.querySelectorAll(".band-filter").forEach((button) => {
          button.addEventListener("click", function () {
            // Remove active class from all buttons
            document.querySelectorAll(".band-filter").forEach((btn) => {
              btn.classList.remove("active");
            });

            // Add active class to clicked button
            this.classList.add("active");

            // Filter the table
            const band = this.getAttribute("data-band");
            filterBandingsTable(band);
          });
        });

        // Update comparison button
        document
          .getElementById("update-comparison-btn")
          .addEventListener("click", updateComparisonTab);

        // Always show ARRS entitlement summary on startup
        const weightedPopulation =
          parseFloat(document.getElementById("weighted-population").value) || 0;
        updateArrsEntitlementSummary(weightedPopulation);

        // Add event listener for funding reallocation
        document
          .getElementById("apply-reallocation")
          .addEventListener("click", applyFundingReallocation);

        // Monthly tracker event listeners
        document
          .getElementById("update-monthly-view")
          .addEventListener("click", updateMonthlyTracker);
        document
          .getElementById("update-monthly-btn")
          .addEventListener("click", updateMonthlyTracker);
        document
          .getElementById("export-monthly-csv")
          .addEventListener("click", exportMonthlyTrackerToCsv);
        document
          .getElementById("monthly-view-year")
          .addEventListener("change", function () {
            // Auto-update when year changes
            updateMonthlyTracker();
          });

        // Forecast event listeners
        document
          .getElementById("update-forecast")
          .addEventListener("click", updateForecast);
        document
          .getElementById("apply-forecast-settings")
          .addEventListener("click", updateForecast);
        document
          .getElementById("export-forecast-csv")
          .addEventListener("click", exportForecastToCsv);
        document
          .getElementById("save-forecast")
          .addEventListener("click", saveForecastScenario);
        document
          .getElementById("forecast-scenario")
          .addEventListener("change", toggleForecastOptions);

        // Initial update of summary values
        updateSummary();

        // Initialize comparison tab
        updateComparisonTab();

        // Initialize bandings table
        updateBandingsTable();

        // Initialize monthly tracker
        updateMonthlyTracker();
      }

      // Calculate financial entitlements
      function calculateFinancialEntitlements() {
        // Get input values
        const rawListSize =
          parseFloat(document.getElementById("raw-list-size").value) || 0;
        const adjustedPopulation =
          parseFloat(document.getElementById("adjusted-population").value) || 0;
        const careHomeBedCount =
          parseInt(document.getElementById("care-home-beds").value) || 0;
        const iifPointsAchieved =
          parseInt(document.getElementById("iif-points").value) || 0;
        const caipRiskStratification = document.getElementById(
          "caip-risk-stratification"
        ).checked;
        const caipModernAccess =
          document.getElementById("caip-modern-access").checked;
        const caipAchievementMonth = parseInt(
          document.getElementById("caip-achievement-month").value
        );
        const weightedPopulation =
          parseFloat(document.getElementById("weighted-population").value) || 0;

        // Calculate number of remaining months from achievement month to March
        let remainingMonths;
        if (caipAchievementMonth >= 4 && caipAchievementMonth <= 12) {
          // April to December 2025
          remainingMonths = 16 - caipAchievementMonth; // 16 = 12 + 4 (March = month 3)
        } else {
          // January to March 2026
          remainingMonths = 4 - caipAchievementMonth; // 4 = 3 + 1
        }

        // Validate inputs
        if (adjustedPopulation <= 0 || rawListSize <= 0) {
          showNotification(
            "Please enter valid Raw List Size and Adjusted Population values."
          );
          return;
        }

        // Calculate annual entitlements
        // Core PCN Funding (calculated as 2.266 × raw list size + 0.733 × adjusted population)
        const corePCNFundingAmount =
          financialParams.corePCNFundingRawListRate * rawListSize +
          financialParams.corePCNFundingAdjustedPopRate * adjustedPopulation;

        // Enhanced Access Payment
        const enhancedAccessAmount =
          financialParams.enhancedAccessPayment * adjustedPopulation;

        // Care Home Premium - using annual rate for annual calculation
        const careHomePremiumAmount =
          financialParams.careHomePremiumAnnual * careHomeBedCount;

        // For monthly calculation, we'll use the exact monthly rate later

        // Capacity and Access Support Payment
        const capacityAccessAmount =
          financialParams.capacityAndAccessSupportPayment * adjustedPopulation;

        // Local Capacity and Access Improvement Payment (CAIP) - based on elements achieved
        // Risk stratification = 1/3 of CAIP, Modern Access = 2/3 of CAIP
        let caipAchievementPercent = 0;
        if (caipRiskStratification) caipAchievementPercent += 1 / 3;
        if (caipModernAccess) caipAchievementPercent += 2 / 3;
        const caipAmount =
          financialParams.caipPayment *
          adjustedPopulation *
          caipAchievementPercent;

        // Investment and Impact Fund (IIF) - based on points achieved
        const iifAmount = financialParams.iifPointValue * iifPointsAchieved;

        // Additional Roles Reimbursement Sum (using weighted population)
        const arrsAmount = financialParams.arrsPayment * weightedPopulation;

        // Calculate subtotal (excluding ARRS)
        const subtotal =
          corePCNFundingAmount +
          enhancedAccessAmount +
          careHomePremiumAmount +
          capacityAccessAmount +
          caipAmount +
          iifAmount;

        // Calculate grand total (including ARRS)
        const grandTotal = subtotal + arrsAmount;

        // Display results - formatted to 2 decimal places and with commas for thousands
        const formatter = new Intl.NumberFormat("en-UK", {
          style: "currency",
          currency: "GBP",
          minimumFractionDigits: 0,
          maximumFractionDigits: 0,
        });

        // Annual amounts
        document.getElementById("core-pcn-funding-annual").textContent =
          formatter.format(corePCNFundingAmount);
        document.getElementById("enhanced-access-annual").textContent =
          formatter.format(enhancedAccessAmount);
        document.getElementById("care-home-premium-annual").textContent =
          formatter.format(careHomePremiumAmount);
        document.getElementById("capacity-access-annual").textContent =
          formatter.format(capacityAccessAmount);
        document.getElementById("caip-annual").textContent =
          formatter.format(caipAmount);
        document.getElementById("iif-annual").textContent =
          formatter.format(iifAmount);
        document.getElementById("arrs-annual").textContent =
          formatter.format(arrsAmount);
        document.getElementById("subtotal-annual").textContent =
          formatter.format(subtotal);
        document.getElementById("total-annual").textContent =
          formatter.format(grandTotal);

        // Monthly amounts (annual / 12)
        document.getElementById("core-pcn-funding-monthly").textContent =
          formatter.format(corePCNFundingAmount / 12);
        document.getElementById("enhanced-access-monthly").textContent =
          formatter.format(enhancedAccessAmount / 12);
        document.getElementById("care-home-premium-monthly").textContent =
          formatter.format(
            financialParams.careHomePremiumMonthly * careHomeBedCount
          );
        document.getElementById("capacity-access-monthly").textContent =
          formatter.format(capacityAccessAmount / 12);
        // Calculate the monthly CAIP payment based on remaining months
        // If there are no remaining months (submitted in March), show £0
        const caipMonthlyAmount =
          remainingMonths > 0 ? caipAmount / remainingMonths : 0;
        document.getElementById("caip-monthly").textContent =
          formatter.format(caipMonthlyAmount);
        document.getElementById("iif-monthly").textContent =
          "£0 (paid annually)";
        document.getElementById("arrs-monthly").textContent = formatter.format(
          arrsAmount / 12
        );
        // Re-calculate subtotal monthly (excluding the IIF since it's annual only)
        // For CAIP, use the adjusted monthly amount based on achievement month
        const subtotalMonthlyAmount =
          (subtotal - iifAmount - caipAmount) / 12 +
          (remainingMonths > 0 ? caipAmount / remainingMonths : 0);
        document.getElementById("subtotal-monthly").textContent =
          formatter.format(subtotalMonthlyAmount);
        // Re-calculate grand total monthly (excluding the IIF since it's annual only)
        // For CAIP, use the adjusted monthly amount based on achievement month
        const grandTotalMonthlyAmount =
          (grandTotal - iifAmount - caipAmount) / 12 +
          (remainingMonths > 0 ? caipAmount / remainingMonths : 0);
        document.getElementById("total-monthly").textContent = formatter.format(
          grandTotalMonthlyAmount
        );

        // Show results section
        document.getElementById("finance-results-section").style.display =
          "block";

        // Update the comparison data without showing it
        updateComparisonTab();

        // Show a notification about the comparison
        if (staffList && staffList.length > 0) {
          // Add a notification with a link to the comparison tab
          setTimeout(() => {
            showNotification(
              "ARRS comparison data updated. View in the ARRS Comparison tab."
            );
          }, 1000);
        }

        // Update the ARRS entitlement summary in the ARRS calculator tab
        updateArrsEntitlementSummary(weightedPopulation);

        showNotification("Financial entitlements calculated successfully");
      }

      // Reset finance calculator
      function resetFinanceCalculator() {
        document.getElementById("raw-list-size").value = "";
        document.getElementById("adjusted-population").value = "";
        document.getElementById("care-home-beds").value = "0";
        document.getElementById("weighted-population").value = "";
        document.getElementById("iif-points").value = "58";
        document.getElementById("caip-risk-stratification").checked = true;
        document.getElementById("caip-modern-access").checked = true;

        // Hide results section
        document.getElementById("finance-results-section").style.display =
          "none";

        // Reset ARRS entitlement card values
        updateArrsEntitlementSummary(0);
      }

      // Update the Comparison tab
      function updateComparisonTab() {
        const weightedPopulation =
          parseFloat(document.getElementById("weighted-population").value) || 0;
        const formatter = new Intl.NumberFormat("en-UK", {
          style: "currency",
          currency: "GBP",
          minimumFractionDigits: 0,
          maximumFractionDigits: 0,
        });

        // Update timestamp
        const now = new Date();
        document.getElementById("comparison-last-updated").textContent =
          now.toLocaleString();

        // Update workforce summary
        let totalWte = 0;
        const staffCount = staffList.length;

        // Calculate workforce totals
        staffList.forEach((staff) => {
          totalWte += staff.wte;
        });

        document.getElementById("comparison-total-wte").textContent =
          totalWte.toFixed(1);
        document.getElementById("comparison-total-staff").textContent =
          staffCount;

        // Update funding details
        document.getElementById("comparison-weighted-population").textContent =
          weightedPopulation.toLocaleString();

        if (weightedPopulation > 0) {
          // Calculate ARRS entitlement and usage
          const arrsAmount = financialParams.arrsPayment * weightedPopulation;
          let totalReimbursableCost = 0;

          staffList.forEach((staff) => {
            totalReimbursableCost += staff.reimbursableAmount;
          });

          const remainingArrs = arrsAmount - totalReimbursableCost;

          // Update table values
          document.getElementById("comparison-max-arrs-annual").textContent =
            formatter.format(arrsAmount);
          document.getElementById("comparison-max-arrs-monthly").textContent =
            formatter.format(arrsAmount / 12);
          document.getElementById(
            "comparison-current-arrs-annual"
          ).textContent = formatter.format(totalReimbursableCost);
          document.getElementById(
            "comparison-current-arrs-monthly"
          ).textContent = formatter.format(totalReimbursableCost / 12);
          document.getElementById(
            "comparison-remaining-arrs-annual"
          ).textContent = formatter.format(remainingArrs);
          document.getElementById(
            "comparison-remaining-arrs-monthly"
          ).textContent = formatter.format(remainingArrs / 12);

          // Update utilization bar
          const utilizationPercentage =
            (totalReimbursableCost / arrsAmount) * 100;
          const cappedPercentage = Math.min(
            100,
            Math.max(0, utilizationPercentage)
          ); // Cap between 0 and 100
          document.getElementById(
            "comparison-arrs-utilization-percentage"
          ).textContent = cappedPercentage.toFixed(1) + "%";
          document.getElementById("comparison-arrs-progress-bar").style.width =
            cappedPercentage + "%";

          // Change color based on utilization level
          const progressBar = document.getElementById(
            "comparison-arrs-progress-bar"
          );
          if (utilizationPercentage <= 75) {
            // Good - plenty of funding left
            progressBar.style.backgroundColor = "#34a853"; // Green
          } else if (utilizationPercentage <= 95) {
            // Warning - getting close to limit
            progressBar.style.backgroundColor = "#fbbc05"; // Yellow
          } else {
            // Danger - at or over limit
            progressBar.style.backgroundColor = "#ea4335"; // Red
          }

          // Change color of remaining ARRS row based on balance
          const arrsBalanceRow = document.getElementById(
            "comparison-arrs-balance-row"
          );
          if (remainingArrs < 0) {
            arrsBalanceRow.style.backgroundColor = "rgba(234, 67, 53, 0.1)"; // Red background
            document.getElementById(
              "comparison-remaining-arrs-annual"
            ).style.color = "#ea4335";
            document.getElementById(
              "comparison-remaining-arrs-monthly"
            ).style.color = "#ea4335";
          } else {
            arrsBalanceRow.style.backgroundColor = "rgba(52, 168, 83, 0.1)"; // Green background
            document.getElementById(
              "comparison-remaining-arrs-annual"
            ).style.color = "white";
            document.getElementById(
              "comparison-remaining-arrs-monthly"
            ).style.color = "white";
          }

          // Show notification
          showNotification("ARRS comparison updated successfully");
        } else {
          // Show message if no weighted population is set
          showNotification(
            "Please enter weighted population in Financial Calculator tab"
          );
          setActiveTab("finance");
          document.getElementById("weighted-population").focus();
        }
      }

      // Update ARRS entitlement summary in the main calculator tab
      function updateArrsEntitlementSummary(weightedPopulation) {
        const formatter = new Intl.NumberFormat("en-UK", {
          style: "currency",
          currency: "GBP",
          minimumFractionDigits: 0,
          maximumFractionDigits: 0,
        });

        if (weightedPopulation > 0) {
          const arrsAmount = financialParams.arrsPayment * weightedPopulation;

          // Update population and funding displays
          document.getElementById("summary-weighted-population").textContent =
            weightedPopulation.toLocaleString();
          document.getElementById("summary-max-annual-funding").textContent =
            formatter.format(arrsAmount);
          document.getElementById("summary-max-monthly-funding").textContent =
            formatter.format(arrsAmount / 12);

          // Show the with-population note and hide the no-population note
          document.getElementById("arrs-note-with-population").style.display =
            "block";
          document.getElementById("arrs-note-no-population").style.display =
            "none";

          // Update the summary card in main tab to show remaining allocation
          if (staffList && staffList.length > 0) {
            let totalReimbursableCost = 0;

            // Calculate total reimbursable amount from the staff list
            staffList.forEach((staff) => {
              totalReimbursableCost += staff.reimbursableAmount;
            });

            // Update total reimbursable in the main ARRS calculator
            const fundingGap = arrsAmount - totalReimbursableCost;

            // Update the funding gap/surplus display in the main ARRS calculator
            const totalReimbursableEl =
              document.getElementById("total-reimbursable");
            if (totalReimbursableEl) {
              totalReimbursableEl.textContent = formatter.format(arrsAmount);
            }

            const fundingGapEl = document.getElementById("funding-gap");
            if (fundingGapEl) {
              if (fundingGap >= 0) {
                fundingGapEl.textContent = formatter.format(fundingGap);
                fundingGapEl.style.color = "white";
              } else {
                fundingGapEl.textContent =
                  "-" + formatter.format(Math.abs(fundingGap));
                fundingGapEl.style.color = "var(--warning-color)";
              }
            }

            // Update utilization bar
            const utilizationPercentage =
              (totalReimbursableCost / arrsAmount) * 100;
            const cappedPercentage = Math.min(
              100,
              Math.max(0, utilizationPercentage)
            ); // Cap between 0 and 100
            document.getElementById(
              "arrs-utilization-percentage-summary"
            ).textContent = cappedPercentage.toFixed(1) + "%";
            document.getElementById("arrs-progress-bar-summary").style.width =
              cappedPercentage + "%";

            // Change color based on utilization level
            const progressBar = document.getElementById(
              "arrs-progress-bar-summary"
            );
            if (utilizationPercentage <= 75) {
              // Good - plenty of funding left
              progressBar.style.backgroundColor = "#34a853"; // Green
            } else if (utilizationPercentage <= 95) {
              // Warning - getting close to limit
              progressBar.style.backgroundColor = "#fbbc05"; // Yellow
            } else {
              // Danger - at or over limit
              progressBar.style.backgroundColor = "#ea4335"; // Red
            }
          } else {
            // No staff yet - reset utilization to 0%
            document.getElementById(
              "arrs-utilization-percentage-summary"
            ).textContent = "0.0%";
            document.getElementById("arrs-progress-bar-summary").style.width =
              "0%";
            document.getElementById(
              "arrs-progress-bar-summary"
            ).style.backgroundColor = "#34a853"; // Green
          }
        } else {
          // Still show the card but with zeros and appropriate message
          document.getElementById("summary-weighted-population").textContent =
            "0";
          document.getElementById("summary-max-annual-funding").textContent =
            "£0";
          document.getElementById("summary-max-monthly-funding").textContent =
            "£0";

          // Hide the with-population note and show the no-population note
          document.getElementById("arrs-note-with-population").style.display =
            "none";
          document.getElementById("arrs-note-no-population").style.display =
            "block";

          // Reset utilization to 0%
          document.getElementById(
            "arrs-utilization-percentage-summary"
          ).textContent = "0.0%";
          document.getElementById("arrs-progress-bar-summary").style.width =
            "0%";
        }
      }

      // Update and filter bandings table
      function updateBandingsTable() {
        const location = document.getElementById("bandings-location").value;
        const tableBody = document.getElementById("arrs-bandings-body");
        tableBody.innerHTML = "";

        // Update location display
        document.getElementById("bandings-location-display").textContent =
          "Location: " +
          (location === "national"
            ? "National"
            : location === "inner-london"
            ? "Inner London"
            : "Outer London");

        // Formatter for currency
        const formatter = new Intl.NumberFormat("en-UK", {
          style: "currency",
          currency: "GBP",
          minimumFractionDigits: 0,
          maximumFractionDigits: 0,
        });

        // Loop through reimbursable amounts
        for (const [role, data] of Object.entries(reimbursableAmounts)) {
          // Skip mental health practitioners (handled separately)
          if (role === "mental-health-5050" || role === "mental-health-100") {
            continue;
          }

          // For each band
          data.bands.forEach((band) => {
            const maxReimbursement = data[location];
            const monthlyReimbursement = maxReimbursement / 12;

            // Get band details
            const bandDetails = afcBands[band];

            // Create a row
            const row = document.createElement("tr");
            row.setAttribute("data-band", band);

            // Add cells
            row.innerHTML = `
                        <td>${roleTitles[role]}</td>
                        <td>${band === "gp" ? "GP Scale" : "Band " + band}</td>
                        <td>${formatter.format(maxReimbursement)}</td>
                        <td>${formatter.format(monthlyReimbursement)}</td>
                        <td>${formatter.format(bandDetails.entry)}</td>
                        <td>${formatter.format(bandDetails.mid)}</td>
                        <td>${formatter.format(bandDetails.max)}</td>
                    `;

            tableBody.appendChild(row);
          });
        }

        // Handle mental health practitioners (50/50 model)
        const mh50 = reimbursableAmounts["mental-health-5050"];
        mh50.bands.forEach((band) => {
          const maxReimbursement = mh50[band][location];
          const monthlyReimbursement = maxReimbursement / 12;

          // Get band details
          const bandDetails = afcBands[band];

          // Create a row
          const row = document.createElement("tr");
          row.setAttribute("data-band", band);

          // Add cells
          row.innerHTML = `
                    <td>Mental Health Practitioner (50/50)</td>
                    <td>Band ${band}</td>
                    <td>${formatter.format(maxReimbursement)}</td>
                    <td>${formatter.format(monthlyReimbursement)}</td>
                    <td>${formatter.format(bandDetails.entry)}</td>
                    <td>${formatter.format(bandDetails.mid)}</td>
                    <td>${formatter.format(bandDetails.max)}</td>
                `;

          tableBody.appendChild(row);
        });

        // Handle mental health practitioners (100% model)
        const mh100 = reimbursableAmounts["mental-health-100"];
        mh100.bands.forEach((band) => {
          const maxReimbursement = mh100[band][location];
          const monthlyReimbursement = maxReimbursement / 12;

          // Get band details
          const bandDetails = afcBands[band];

          // Create a row
          const row = document.createElement("tr");
          row.setAttribute("data-band", band);

          // Add cells
          row.innerHTML = `
                    <td>Mental Health Practitioner (100%)</td>
                    <td>Band ${band}</td>
                    <td>${formatter.format(maxReimbursement)}</td>
                    <td>${formatter.format(monthlyReimbursement)}</td>
                    <td>${formatter.format(bandDetails.entry)}</td>
                    <td>${formatter.format(bandDetails.mid)}</td>
                    <td>${formatter.format(bandDetails.max)}</td>
                `;

          tableBody.appendChild(row);
        });

        // Get current active filter
        const activeFilter = document.querySelector(".band-filter.active");
        if (activeFilter) {
          filterBandingsTable(activeFilter.getAttribute("data-band"));
        }

        // Show notification
        showNotification(
          "ARRS bandings updated for " +
            (location === "national"
              ? "National"
              : location === "inner-london"
              ? "Inner London"
              : "Outer London") +
            " location"
        );
      }

      // Filter bandings table by band
      function filterBandingsTable(bandFilter) {
        const rows = document.querySelectorAll("#arrs-bandings-body tr");

        if (bandFilter === "all") {
          // Show all rows
          rows.forEach((row) => {
            row.style.display = "";
          });
        } else {
          // Filter rows
          rows.forEach((row) => {
            if (row.getAttribute("data-band") === bandFilter) {
              row.style.display = "";
            } else {
              row.style.display = "none";
            }
          });
        }
      }

      // Function to update location display
      function updateLocationDisplay() {
        const location = locationSelect.value;
        const locationDisplayEl = document.getElementById("location-display");

        if (location === "national") {
          locationDisplayEl.textContent = "Location: National";
        } else if (location === "inner-london") {
          locationDisplayEl.textContent = "Location: Inner London";
        } else if (location === "outer-london") {
          locationDisplayEl.textContent = "Location: Outer London";
        }
      }

      // Function to update band options based on selected role
      function updateBandOptions() {
        const role = roleSelect.value;
        bandSelect.innerHTML = '<option value="">Select band...</option>';

        if (!role) return;

        // Special handling for mental health practitioners
        if (role === "mental-health-5050" || role === "mental-health-100") {
          const bands = reimbursableAmounts[role].bands;
          bands.forEach((band) => {
            const option = document.createElement("option");
            option.value = band;
            option.textContent = `Band ${band}`;
            bandSelect.appendChild(option);
          });
        } else {
          const bands = reimbursableAmounts[role].bands;
          bands.forEach((band) => {
            const option = document.createElement("option");
            option.value = band;
            option.textContent = band === "gp" ? "GP Scale" : `Band ${band}`;
            bandSelect.appendChild(option);
          });
        }

        // Select first option by default
        if (bandSelect.options.length > 1) {
          bandSelect.selectedIndex = 1;
        }
      }

      // Set active tab
      function setActiveTab(tabId) {
        tabs.forEach((tab) => {
          if (tab.getAttribute("data-tab") === tabId) {
            tab.classList.add("active");
          } else {
            tab.classList.remove("active");
          }
        });

        tabContents.forEach((content) => {
          if (content.getAttribute("data-tab") === tabId) {
            content.classList.add("active");
          } else {
            content.classList.remove("active");
          }
        });
      }

      // Add staff member
      function addStaffMember() {
        // Validate inputs with visual feedback
        // Validate inputs
        const name = staffNameInput.value.trim();
        const role = roleSelect.value;
        const band = bandSelect.value;
        const location = locationSelect.value;
        const experience = experienceSelect.value;
        const wte = parseFloat(wteInput.value);
        const startDate = startDateInput.value;
        const lastPayIncreaseDate =
          document.getElementById("last-pay-increase").value;
        const salaryOverride = salaryOverrideInput.value
          ? parseFloat(salaryOverrideInput.value)
          : null;

        function showFieldError(element, message) {
          element.style.borderColor = "var(--warning-color)";
          const errorMsg = document.createElement("div");
          errorMsg.className = "field-error";
          errorMsg.textContent = message;
          element.parentNode.appendChild(errorMsg);

          setTimeout(() => {
            element.style.borderColor = "";
            element.parentNode.removeChild(errorMsg);
          }, 3000);

          element.focus();
        }

        // Clear any previous errors
        document.querySelectorAll(".field-error").forEach((el) => el.remove());

        if (!name) {
          showFieldError(staffNameInput, "Please enter a staff name");
          return;
        }

        if (!role) {
          showFieldError(roleSelect, "Please select a role");
          return;
        }

        if (!band) {
          showFieldError(bandSelect, "Please select a band");
          return;
        }

        if (isNaN(wte) || wte < 0.1 || wte > 1) {
          showFieldError(wteInput, "WTE must be between 0.1 and 1.0");
          return;
        }

        if (!startDate) {
          showFieldError(startDateInput, "Please select a start date");
          return;
        }

        // Calculate salary and reimbursement
        let baseSalary, maxReimbursement;

        // Get base salary from AfC bands
        baseSalary = afcBands[band][experience];

        // Get max reimbursement amount
        if (role === "mental-health-5050" || role === "mental-health-100") {
          maxReimbursement = reimbursableAmounts[role][band][location];
        } else {
          maxReimbursement = reimbursableAmounts[role][location];
        }

        // Use override salary if provided
        if (salaryOverride) {
          baseSalary = salaryOverride;
        }

        // Calculate employer costs
        const annualSalary = baseSalary * wte;
        let niContribution = Math.max(
          0,
          (annualSalary - NI_THRESHOLD) * NI_RATE
        );
        const pensionContribution = annualSalary * PENSION_RATE;
        const totalCost = annualSalary + niContribution + pensionContribution;
        const reimbursableAmount = maxReimbursement * wte;

        // Create staff object
        const staffMember = {
          id: Date.now(), // Unique ID for the staff member
          name,
          role,
          band,
          location,
          experience,
          wte,
          startDate,
          lastPayIncreaseDate,
          baseSalary,
          annualSalary,
          niContribution,
          pensionContribution,
          totalCost,
          maxReimbursement,
          reimbursableAmount,
          salaryOverride,
        };

        // Add to staff list
        staffList.push(staffMember);

        // Save data
        saveData();

        // Show success notification
        showNotification(`Staff member "${name}" added successfully`);

        // Render staff list
        renderStaffList();

        // Update comparison tab data (but don't switch to it)
        updateComparisonTab();

        // Clear form
        clearForm();
      }

      // Render staff list
      function renderStaffList() {
        if (staffList.length === 0) {
          staffEntriesContainer.innerHTML =
            '<div class="note">No staff members added yet. Use the form above to add staff.</div>';
          updateSummary();
          return;
        }

        staffEntriesContainer.innerHTML = "";

        staffList.forEach((staff) => {
          const statusClass =
            staff.totalCost <= staff.reimbursableAmount
              ? "status-ok"
              : "status-warning";
          const statusText =
            staff.totalCost <= staff.reimbursableAmount
              ? "Within budget"
              : "Exceeds reimbursable amount";

          const staffItem = document.createElement("div");
          staffItem.className = "staff-item";
          staffItem.innerHTML = `
                    <div class="staff-header">
                        <h3>${staff.name} - ${roleTitles[staff.role]}</h3>
                        <div class="status-indicator ${statusClass}">${statusText}</div>
                    </div>
                    <div class="staff-details">
                        <div class="staff-detail">
                            <span>Band:</span> ${
                              staff.band === "gp"
                                ? "GP Scale"
                                : "Band " + staff.band
                            }
                        </div>
                        <div class="staff-detail">
                            <span>Experience:</span> ${
                              staff.experience === "entry"
                                ? "Entry Point"
                                : staff.experience === "mid"
                                ? "Mid Point"
                                : "Maximum Point"
                            }
                        </div>
                        <div class="staff-detail">
                            <span>WTE:</span> ${staff.wte}
                        </div>
                        <div class="staff-detail">
                            <span>Start Date:</span> ${new Date(
                              staff.startDate
                            ).toLocaleDateString()}
                        </div>
                        <div class="staff-detail">
                            <span>Last Pay Increase:</span> ${
                              staff.lastPayIncreaseDate
                                ? new Date(
                                    staff.lastPayIncreaseDate
                                  ).toLocaleDateString()
                                : "N/A"
                            }
                        </div>
                        <div class="staff-detail">
                            <span>Base Salary:</span> £${staff.baseSalary.toLocaleString()}
                        </div>
                        <div class="staff-detail">
                            <span>Annual Salary:</span> £${staff.annualSalary.toLocaleString()}
                        </div>
                        <div class="staff-detail">
                            <span>Employer NI:</span> £${Math.round(
                              staff.niContribution
                            ).toLocaleString()}
                        </div>
                        <div class="staff-detail">
                            <span>Employer Pension:</span> £${Math.round(
                              staff.pensionContribution
                            ).toLocaleString()}
                        </div>
                        <div class="staff-detail">
                            <span>Total Cost:</span> £${Math.round(
                              staff.totalCost
                            ).toLocaleString()}
                        </div>
                        <div class="staff-detail">
                            <span>Max Reimbursable:</span> £${staff.reimbursableAmount.toLocaleString()}
                        </div>
                    </div>
                    <button class="remove-staff" data-id="${
                      staff.id
                    }">×</button>
                `;

          staffEntriesContainer.appendChild(staffItem);
        });

        // Add event listeners for remove buttons
        document.querySelectorAll(".remove-staff").forEach((button) => {
          button.addEventListener("click", function () {
            const id = parseInt(this.getAttribute("data-id"));
            removeStaffMember(id);
          });
        });

        // Update summary
        updateSummary();
      }

      // Update summary
      function updateSummary() {
        if (staffList.length === 0) {
          totalSalaryEl.textContent = "£0";
          totalNiEl.textContent = "£0";
          totalPensionEl.textContent = "£0";
          totalCostEl.textContent = "£0";
          totalReimbursableEl.textContent = "£0";
          fundingGapEl.textContent = "£0";
          totalWteEl.textContent = "0";

          // Hide funding reallocation section
          document.getElementById(
            "funding-reallocation-section"
          ).style.display = "none";
          return;
        }

        let totalSalary = 0;
        let totalNi = 0;
        let totalPension = 0;
        let totalCost = 0;
        let totalReimbursable = 0;
        let totalWte = 0;

        staffList.forEach((staff) => {
          totalSalary += staff.annualSalary;
          totalNi += staff.niContribution;
          totalPension += staff.pensionContribution;
          totalCost += staff.totalCost;
          totalReimbursable += staff.reimbursableAmount;
          totalWte += staff.wte;
        });

        // Get the weighted population from the financial calculator if available
        const weightedPopulation =
          parseFloat(document.getElementById("weighted-population").value) || 0;

        // If we have a weighted population, use the calculated ARRS entitlement
        if (weightedPopulation > 0) {
          const arrsAmount = financialParams.arrsPayment * weightedPopulation;
          const fundingGap = arrsAmount - totalCost;

          totalSalaryEl.textContent =
            "£" + Math.round(totalSalary).toLocaleString();
          totalNiEl.textContent = "£" + Math.round(totalNi).toLocaleString();
          totalPensionEl.textContent =
            "£" + Math.round(totalPension).toLocaleString();
          totalCostEl.textContent =
            "£" + Math.round(totalCost).toLocaleString();
          totalReimbursableEl.textContent =
            "£" + Math.round(arrsAmount).toLocaleString();

          if (fundingGap >= 0) {
            fundingGapEl.textContent =
              "£" + Math.round(fundingGap).toLocaleString();
            fundingGapEl.style.color = "white";

            // Hide funding reallocation section as there's no funding gap
            document.getElementById(
              "funding-reallocation-section"
            ).style.display = "none";
          } else {
            fundingGapEl.textContent =
              "-£" + Math.round(Math.abs(fundingGap)).toLocaleString();
            fundingGapEl.style.color = "var(--warning-color)";

            // Check if financial calculator data is available
            const rawListSize =
              parseFloat(document.getElementById("raw-list-size").value) || 0;
            const adjustedPopulation =
              parseFloat(
                document.getElementById("adjusted-population").value
              ) || 0;

            if (rawListSize > 0 && adjustedPopulation > 0) {
              // Show funding reallocation section and update gap amount
              document.getElementById(
                "funding-reallocation-section"
              ).style.display = "block";
              document.getElementById("funding-gap-amount").textContent =
                "-£" + Math.round(Math.abs(fundingGap)).toLocaleString();

              // Update available amounts from each funding stream
              updateFundingReallocationOptions();
            } else {
              // Hide funding reallocation section as financial data is not available
              document.getElementById(
                "funding-reallocation-section"
              ).style.display = "none";
            }
          }

          totalWteEl.textContent = totalWte.toFixed(1);

          // Show the funding note
          document.getElementById("funding-note").style.display = "block";
        } else {
          // Otherwise use the legacy calculation based on reimbursable amounts
          const fundingGap = totalReimbursable - totalCost;

          totalSalaryEl.textContent =
            "£" + Math.round(totalSalary).toLocaleString();
          totalNiEl.textContent = "£" + Math.round(totalNi).toLocaleString();
          totalPensionEl.textContent =
            "£" + Math.round(totalPension).toLocaleString();
          totalCostEl.textContent =
            "£" + Math.round(totalCost).toLocaleString();
          totalReimbursableEl.textContent =
            "£" + Math.round(totalReimbursable).toLocaleString();

          if (fundingGap >= 0) {
            fundingGapEl.textContent =
              "£" + Math.round(fundingGap).toLocaleString();
            fundingGapEl.style.color = "white";

            // Hide funding reallocation section
            document.getElementById(
              "funding-reallocation-section"
            ).style.display = "none";
          } else {
            fundingGapEl.textContent =
              "-£" + Math.round(Math.abs(fundingGap)).toLocaleString();
            fundingGapEl.style.color = "var(--warning-color)";

            // Hide funding reallocation section as we need weighted population data
            document.getElementById(
              "funding-reallocation-section"
            ).style.display = "none";
          }

          totalWteEl.textContent = totalWte.toFixed(1);

          // Show the funding note to encourage using the financial calculator
          document.getElementById("funding-note").style.display = "block";
        }
      }

      // Update funding reallocation options based on financial calculator data
      function updateFundingReallocationOptions() {
        const rawListSize =
          parseFloat(document.getElementById("raw-list-size").value) || 0;
        const adjustedPopulation =
          parseFloat(document.getElementById("adjusted-population").value) || 0;
        const careHomeBedCount =
          parseInt(document.getElementById("care-home-beds").value) || 0;
        const iifPointsAchieved =
          parseInt(document.getElementById("iif-points").value) || 0;

        if (rawListSize <= 0 || adjustedPopulation <= 0) {
          return; // Financial calculator not populated
        }

        // Calculate each funding stream amount
        const corePCNFundingAmount =
          financialParams.corePCNFundingRawListRate * rawListSize +
          financialParams.corePCNFundingAdjustedPopRate * adjustedPopulation;

        const enhancedAccessAmount =
          financialParams.enhancedAccessPayment * adjustedPopulation;
        const careHomePremiumAmount =
          financialParams.careHomePremiumAnnual * careHomeBedCount;
        const capacityAccessAmount =
          financialParams.capacityAndAccessSupportPayment * adjustedPopulation;
        const iifAmount = financialParams.iifPointValue * iifPointsAchieved;

        // Format amounts for display
        const formatter = new Intl.NumberFormat("en-UK", {
          style: "currency",
          currency: "GBP",
          minimumFractionDigits: 0,
          maximumFractionDigits: 0,
        });

        // Update available amounts
        document.getElementById("core-pcn-available").textContent =
          formatter.format(corePCNFundingAmount);
        document.getElementById("capacity-access-available").textContent =
          formatter.format(capacityAccessAmount);
        document.getElementById("iif-available").textContent =
          formatter.format(iifAmount);
        document.getElementById("care-home-available").textContent =
          formatter.format(careHomePremiumAmount);
        document.getElementById("enhanced-access-available").textContent =
          formatter.format(enhancedAccessAmount);
      }

      // Apply funding reallocation
      function applyFundingReallocation() {
        // Get checked funding sources
        const useCoreFunding =
          document.getElementById("use-core-funding").checked;
        const useCapacityAccess = document.getElementById(
          "use-capacity-access"
        ).checked;
        const useIIF = document.getElementById("use-iif").checked;
        const useCareHome = document.getElementById("use-care-home").checked;
        const useEnhancedAccess = document.getElementById(
          "use-enhanced-access"
        ).checked;

        if (
          !useCoreFunding &&
          !useCapacityAccess &&
          !useIIF &&
          !useCareHome &&
          !useEnhancedAccess
        ) {
          showNotification(
            "Please select at least one funding source to reallocate from"
          );
          return;
        }

        // Get the funding gap amount (remove currency symbol and commas)
        const fundingGapText =
          document.getElementById("funding-gap-amount").textContent;
        const fundingGapAmount = Math.abs(
          parseFloat(fundingGapText.replace(/[£,-]/g, ""))
        );

        // Calculate available funding from selected sources
        const rawListSize =
          parseFloat(document.getElementById("raw-list-size").value) || 0;
        const adjustedPopulation =
          parseFloat(document.getElementById("adjusted-population").value) || 0;
        const careHomeBedCount =
          parseInt(document.getElementById("care-home-beds").value) || 0;
        const iifPointsAchieved =
          parseInt(document.getElementById("iif-points").value) || 0;

        let availableFunding = 0;
        let sourcesText = [];

        if (useCoreFunding) {
          const corePCNFundingAmount =
            financialParams.corePCNFundingRawListRate * rawListSize +
            financialParams.corePCNFundingAdjustedPopRate * adjustedPopulation;
          availableFunding += corePCNFundingAmount;
          sourcesText.push("Core PCN Funding");
        }

        if (useCapacityAccess) {
          const capacityAccessAmount =
            financialParams.capacityAndAccessSupportPayment *
            adjustedPopulation;
          availableFunding += capacityAccessAmount;
          sourcesText.push("Capacity and Access Support Payment");
        }

        if (useIIF) {
          const iifAmount = financialParams.iifPointValue * iifPointsAchieved;
          availableFunding += iifAmount;
          sourcesText.push("Investment and Impact Fund");
        }

        if (useCareHome) {
          const careHomePremiumAmount =
            financialParams.careHomePremiumAnnual * careHomeBedCount;
          availableFunding += careHomePremiumAmount;
          sourcesText.push("Care Home Premium");
        }

        if (useEnhancedAccess) {
          const enhancedAccessAmount =
            financialParams.enhancedAccessPayment * adjustedPopulation;
          availableFunding += enhancedAccessAmount;
          sourcesText.push("Enhanced Access Payment");
        }

        // Check if the selected funding sources provide enough funding
        if (availableFunding < fundingGapAmount) {
          showNotification(
            "Selected funding sources do not provide enough funding to cover the gap"
          );
          return;
        }

        // Calculate percentage of each funding source that needs to be reallocated
        const reallocationPercentage =
          (fundingGapAmount / availableFunding) * 100;

        // Create and display the reallocation summary
        const formatter = new Intl.NumberFormat("en-UK", {
          style: "currency",
          currency: "GBP",
          minimumFractionDigits: 0,
          maximumFractionDigits: 0,
        });

        // Create a pop-up summary
        const modal = document.createElement("div");
        modal.style.position = "fixed";
        modal.style.top = "0";
        modal.style.left = "0";
        modal.style.width = "100%";
        modal.style.height = "100%";
        modal.style.backgroundColor = "rgba(0, 0, 0, 0.7)";
        modal.style.zIndex = "1001";
        modal.style.display = "flex";
        modal.style.justifyContent = "center";
        modal.style.alignItems = "center";

        // Modal content
        const content = document.createElement("div");
        content.style.backgroundColor = "white";
        content.style.padding = "30px";
        content.style.borderRadius = "10px";
        content.style.maxWidth = "600px";
        content.style.width = "90%";
        content.style.maxHeight = "80vh";
        content.style.overflow = "auto";
        content.style.position = "relative";

        // Close button
        const closeBtn = document.createElement("button");
        closeBtn.innerHTML = "&times;";
        closeBtn.style.position = "absolute";
        closeBtn.style.top = "10px";
        closeBtn.style.right = "10px";
        closeBtn.style.border = "none";
        closeBtn.style.background = "none";
        closeBtn.style.fontSize = "24px";
        closeBtn.style.cursor = "pointer";
        closeBtn.onclick = function () {
          document.body.removeChild(modal);
        };

        // Modal title
        const title = document.createElement("h2");
        title.textContent = "Funding Reallocation Summary";
        title.style.color = "var(--primary-color)";
        title.style.marginBottom = "20px";

        // Modal content
        let contentHTML = `
                <p>You are about to reallocate ${formatter.format(
                  fundingGapAmount
                )} to cover the ARRS funding gap.</p>
                <p>This will reduce the following funding streams by approximately ${reallocationPercentage.toFixed(
                  1
                )}%:</p>
                <ul>
            `;

        sourcesText.forEach((source) => {
          contentHTML += `<li>${source}</li>`;
        });

        contentHTML += `
                </ul>
                <div style="background-color: #fff4e5; padding: 15px; border-radius: 5px; margin-top: 20px;">
                    <p><strong>Important:</strong> This reallocation is for planning purposes only. You will need to:</p>
                    <ol>
                        <li>Discuss this reallocation with your PCN Board</li>
                        <li>Confirm with your CCG/ICB that this reallocation is permissible</li>
                        <li>Ensure any service commitments attached to these funding streams can still be met</li>
                    </ol>
                </div>
                <div style="margin-top: 20px; text-align: center;">
                    <button id="confirm-reallocation" style="background-color: var(--primary-color); color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin-right: 10px;">Confirm Reallocation</button>
                    <button id="cancel-reallocation" style="background-color: #f0f0f0; border: 1px solid #ddd; padding: 10px 20px; border-radius: 5px; cursor: pointer;">Cancel</button>
                </div>
            `;

        content.innerHTML = contentHTML;
        content.appendChild(closeBtn);
        content.insertBefore(title, content.firstChild);

        modal.appendChild(content);
        document.body.appendChild(modal);

        // Event listeners for the modal buttons
        document
          .getElementById("confirm-reallocation")
          .addEventListener("click", function () {
            // Update the displayed funding gap to show the reallocation
            const weightedPopulation =
              parseFloat(
                document.getElementById("weighted-population").value
              ) || 0;
            const arrsAmount = financialParams.arrsPayment * weightedPopulation;

            // Hide the reallocation section
            document.getElementById(
              "funding-reallocation-section"
            ).style.display = "none";

            // Show confirmation message
            fundingGapEl.textContent = "£0 (after reallocation)";
            fundingGapEl.style.color = "white";

            // Close the modal
            document.body.removeChild(modal);

            // Show notification
            showNotification("Funding successfully reallocated");
          });

        document
          .getElementById("cancel-reallocation")
          .addEventListener("click", function () {
            document.body.removeChild(modal);
          });
      }

      // Update Monthly Tracker
      function updateMonthlyTracker() {
        if (staffList.length === 0) {
          // No staff, show message in the table
          document.getElementById("monthly-tracker-body").innerHTML = `
                    <tr>
                        <td colspan="14" style="text-align: center; padding: 20px;">
                            No staff members added yet. Use the ARRS Calculator tab to add staff.
                        </td>
                    </tr>
                `;

          // Reset totals
          resetMonthlyTotals();
          return;
        }

        // Get selected view options
        const viewYear = parseInt(
          document.getElementById("monthly-view-year").value
        );
        const viewType = document.getElementById("monthly-view-type").value;

        // Calculate financial year start and end
        const fyStart = new Date(viewYear, 3, 1); // April 1st
        const fyEnd = new Date(viewYear + 1, 2, 31); // March 31st next year

        // Clear existing table data
        document.getElementById("monthly-tracker-body").innerHTML = "";

        // Reset monthly totals
        const monthlyTotals = {
          apr: 0,
          may: 0,
          jun: 0,
          jul: 0,
          aug: 0,
          sep: 0,
          oct: 0,
          nov: 0,
          dec: 0,
          jan: 0,
          feb: 0,
          mar: 0,
        };

        // Format for display
        const formatter = new Intl.NumberFormat("en-UK", {
          style: "currency",
          currency: "GBP",
          minimumFractionDigits: 0,
          maximumFractionDigits: 0,
        });

        // Create rows for each staff member
        staffList.forEach((staff) => {
          const staffStartDate = new Date(staff.startDate);
          let annualTotal = 0;

          // Create monthly values based on view type and start date
          const monthlyValues = {};

          // Calculate base value per month based on view type
          let monthlyBaseValue = 0;

          if (viewType === "salary") {
            monthlyBaseValue = staff.annualSalary / 12;
          } else if (viewType === "total") {
            monthlyBaseValue = staff.totalCost / 12;
          } else if (viewType === "reimbursable") {
            monthlyBaseValue = staff.reimbursableAmount / 12;
          }

          // Calculate values for each month
          const months = [
            "apr",
            "may",
            "jun",
            "jul",
            "aug",
            "sep",
            "oct",
            "nov",
            "dec",
            "jan",
            "feb",
            "mar",
          ];

          months.forEach((month, index) => {
            let monthDate;

            // First 9 months (Apr-Dec) are in the first year
            if (index < 9) {
              monthDate = new Date(viewYear, 3 + index, 1);
            } else {
              // Last 3 months (Jan-Mar) are in the following year
              monthDate = new Date(viewYear + 1, index - 9, 1);
            }

            // Only include if staff started before or during this month
            if (staffStartDate <= monthDate) {
              monthlyValues[month] = monthlyBaseValue;
              monthlyTotals[month] += monthlyBaseValue;
              annualTotal += monthlyBaseValue;
            } else {
              monthlyValues[month] = 0;
            }
          });

          // Create the row
          const row = document.createElement("tr");

          // Add staff name cell
          const nameCell = document.createElement("td");
          nameCell.innerHTML = `<strong>${
            staff.name
          }</strong><br><span style="font-size: 0.8em;">${
            roleTitles[staff.role]
          }</span>`;
          row.appendChild(nameCell);

          // Add monthly value cells
          months.forEach((month) => {
            const cell = document.createElement("td");
            cell.textContent = formatter.format(
              Math.round(monthlyValues[month])
            );
            cell.style.textAlign = "right";
            row.appendChild(cell);
          });

          // Add annual total cell
          const totalCell = document.createElement("td");
          totalCell.textContent = formatter.format(Math.round(annualTotal));
          totalCell.style.textAlign = "right";
          totalCell.style.fontWeight = "bold";
          row.appendChild(totalCell);

          // Add row to table
          document.getElementById("monthly-tracker-body").appendChild(row);
        });

        // Update totals in footer
        let grandTotal = 0;
        Object.keys(monthlyTotals).forEach((month) => {
          const value = Math.round(monthlyTotals[month]);
          document.getElementById(`month-total-${month}`).textContent =
            formatter.format(value);
          grandTotal += value;
        });

        document.getElementById("month-total-annual").textContent =
          formatter.format(grandTotal);

        // Update location display in header
        const location = locationSelect.value;
        document.getElementById("monthly-location-display").textContent =
          "Location: " +
          (location === "national"
            ? "National"
            : location === "inner-london"
            ? "Inner London"
            : "Outer London");

        // Update last updated timestamp
        const now = new Date();
        document.getElementById("monthly-last-updated").textContent =
          now.toLocaleString();

        // Show notification
        showNotification("Monthly tracker updated");
      }

      // Populate financial years for the monthly tracker dropdown
      function populateFinancialYears() {
        const yearSelect = document.getElementById("monthly-view-year");
        yearSelect.innerHTML = ""; // Clear existing options

        // Get current date
        const currentDate = new Date();
        const currentMonth = currentDate.getMonth(); // 0-11 (Jan-Dec)

        // Determine the current financial year
        // In the UK, financial year runs April(3) to March(2)
        let currentFY;
        if (currentMonth >= 3) {
          // April onwards
          currentFY = currentDate.getFullYear();
        } else {
          // January to March
          currentFY = currentDate.getFullYear() - 1;
        }

        // Generate options for 3 years back and 5 years forward
        const startYear = currentFY - 3;
        const endYear = currentFY + 5;

        for (let year = startYear; year <= endYear; year++) {
          const option = document.createElement("option");
          option.value = year;
          option.textContent = `${year}-${year + 1}`;

          // Set current FY as selected by default
          if (year === currentFY) {
            option.selected = true;
          }

          yearSelect.appendChild(option);
        }
      }

      // Reset monthly totals to zero
      function resetMonthlyTotals() {
        const months = [
          "apr",
          "may",
          "jun",
          "jul",
          "aug",
          "sep",
          "oct",
          "nov",
          "dec",
          "jan",
          "feb",
          "mar",
        ];

        months.forEach((month) => {
          document.getElementById(`month-total-${month}`).textContent = "£0";
        });

        document.getElementById("month-total-annual").textContent = "£0";
      }

      // Export Monthly Tracker to CSV
      function exportMonthlyTrackerToCsv() {
        if (staffList.length === 0) {
          showNotification("No staff members to export.");
          return;
        }

        // Get view options
        const viewYear = parseInt(
          document.getElementById("monthly-view-year").value
        );
        const viewType = document.getElementById("monthly-view-type").value;

        // Create CSV header
        let csv =
          "Staff Member,Role,Band,Apr,May,Jun,Jul,Aug,Sep,Oct,Nov,Dec,Jan,Feb,Mar,Annual Total\n";

        // Calculate financial year boundaries
        const fyStart = new Date(viewYear, 3, 1); // April 1st
        const fyEnd = new Date(viewYear + 1, 2, 31); // March 31st next year

        // Monthly totals for footer row
        const monthlyTotals = {
          apr: 0,
          may: 0,
          jun: 0,
          jul: 0,
          aug: 0,
          sep: 0,
          oct: 0,
          nov: 0,
          dec: 0,
          jan: 0,
          feb: 0,
          mar: 0,
        };

        // Generate data for each staff member
        staffList.forEach((staff) => {
          const staffStartDate = new Date(staff.startDate);

          // Calculate base value per month based on view type
          let monthlyBaseValue = 0;
          if (viewType === "salary") {
            monthlyBaseValue = staff.annualSalary / 12;
          } else if (viewType === "total") {
            monthlyBaseValue = staff.totalCost / 12;
          } else if (viewType === "reimbursable") {
            monthlyBaseValue = staff.reimbursableAmount / 12;
          }

          // Calculate monthly values
          const months = [
            "apr",
            "may",
            "jun",
            "jul",
            "aug",
            "sep",
            "oct",
            "nov",
            "dec",
            "jan",
            "feb",
            "mar",
          ];
          const monthlyValues = {};
          let annualTotal = 0;

          months.forEach((month, index) => {
            let monthDate;

            // First 9 months (Apr-Dec) are in the first year
            if (index < 9) {
              monthDate = new Date(viewYear, 3 + index, 1);
            } else {
              // Last 3 months (Jan-Mar) are in the following year
              monthDate = new Date(viewYear + 1, index - 9, 1);
            }

            // Only include if staff started before or during this month
            if (staffStartDate <= monthDate) {
              monthlyValues[month] = monthlyBaseValue;
              monthlyTotals[month] += monthlyBaseValue;
              annualTotal += monthlyBaseValue;
            } else {
              monthlyValues[month] = 0;
            }
          });

          // Create row for this staff member
          const row = [
            `"${staff.name}"`,
            `"${roleTitles[staff.role]}"`,
            staff.band === "gp" ? "GP Scale" : `Band ${staff.band}`,
            Math.round(monthlyValues.apr).toLocaleString(),
            Math.round(monthlyValues.may).toLocaleString(),
            Math.round(monthlyValues.jun).toLocaleString(),
            Math.round(monthlyValues.jul).toLocaleString(),
            Math.round(monthlyValues.aug).toLocaleString(),
            Math.round(monthlyValues.sep).toLocaleString(),
            Math.round(monthlyValues.oct).toLocaleString(),
            Math.round(monthlyValues.nov).toLocaleString(),
            Math.round(monthlyValues.dec).toLocaleString(),
            Math.round(monthlyValues.jan).toLocaleString(),
            Math.round(monthlyValues.feb).toLocaleString(),
            Math.round(monthlyValues.mar).toLocaleString(),
            Math.round(annualTotal).toLocaleString(),
          ];

          csv += row.join(",") + "\n";
        });

        // Add totals row
        let totalAnnual = 0;
        Object.values(monthlyTotals).forEach((value) => (totalAnnual += value));

        const totalsRow = [
          '"MONTHLY TOTALS"',
          "",
          "",
          Math.round(monthlyTotals.apr).toLocaleString(),
          Math.round(monthlyTotals.may).toLocaleString(),
          Math.round(monthlyTotals.jun).toLocaleString(),
          Math.round(monthlyTotals.jul).toLocaleString(),
          Math.round(monthlyTotals.aug).toLocaleString(),
          Math.round(monthlyTotals.sep).toLocaleString(),
          Math.round(monthlyTotals.oct).toLocaleString(),
          Math.round(monthlyTotals.nov).toLocaleString(),
          Math.round(monthlyTotals.dec).toLocaleString(),
          Math.round(monthlyTotals.jan).toLocaleString(),
          Math.round(monthlyTotals.feb).toLocaleString(),
          Math.round(monthlyTotals.mar).toLocaleString(),
          Math.round(totalAnnual).toLocaleString(),
        ];

        csv += "\n" + totalsRow.join(",");

        // Add view information
        const viewTypeText =
          viewType === "salary"
            ? "Basic Salary"
            : viewType === "total"
            ? "Total Cost (inc. NI & Pension)"
            : "Reimbursable Amount";

        csv += `\n\n"Financial Year: ${viewYear}-${viewYear + 1}"`;
        csv += `\n"View Type: ${viewTypeText}"`;
        csv += `\n"Generated: ${new Date().toLocaleString()}"`;

        // Create and trigger download
        const blob = new Blob([csv], { type: "text/csv" });
        const url = URL.createObjectURL(blob);

        const a = document.createElement("a");
        a.style.display = "none";
        a.href = url;
        a.download = `pcn_arrs_monthly_tracker_${viewYear}-${viewYear + 1}.csv`;

        document.body.appendChild(a);
        a.click();

        URL.revokeObjectURL(url);
        document.body.removeChild(a);

        showNotification("Monthly tracker exported to CSV");
      }

      // Remove staff member
      function removeStaffMember(id) {
        staffList = staffList.filter((staff) => staff.id !== id);
        saveData();
        renderStaffList();
        updateComparisonTab();
      }

      // Clear form
      function clearForm() {
        staffNameInput.value = "";
        roleSelect.selectedIndex = 0;
        locationSelect.selectedIndex = 0;
        bandSelect.innerHTML = '<option value="">Select band...</option>';
        experienceSelect.selectedIndex = 1; // Default to mid point
        wteInput.value = "1";

        // Set date to today
        const today = new Date();
        startDateInput.value = today.toISOString().split("T")[0];

        // Set last pay increase date to 1st April (start of financial year)
        const currentYear = today.getFullYear();
        const aprilFirst = new Date(currentYear, 3, 1); // Month is 0-indexed, so 3 = April
        document.getElementById("last-pay-increase").value = aprilFirst
          .toISOString()
          .split("T")[0];

        salaryOverrideInput.value = "";
      }

      // Save data to localStorage
      function saveData() {
        // Save staff list
        localStorage.setItem("pcnArrsStaffList", JSON.stringify(staffList));

        // Save monthly tracker preferences
        const monthlyPrefs = {
          year: document.getElementById("monthly-view-year").value,
          viewType: document.getElementById("monthly-view-type").value,
          lastUpdated: new Date().toISOString(),
        };
        localStorage.setItem(
          "pcnArrsMonthlyPrefs",
          JSON.stringify(monthlyPrefs)
        );

        // Update backup area if on data tab
        if (document.querySelector('.tab-content[data-tab="data"].active')) {
          // Create complete data object with all settings
          const completeData = {
            staffList: staffList,
            monthlyPrefs: monthlyPrefs,
            // Add any other settings here
            version: "2025-26", // For future compatibility
          };

          backupArea.value = JSON.stringify(completeData, null, 2);
        }
      }

      // Load data from localStorage
      function loadData() {
        // Load staff list
        const savedData = localStorage.getItem("pcnArrsStaffList");
        if (savedData) {
          staffList = JSON.parse(savedData);
          renderStaffList();
        }

        // Load monthly tracker preferences
        const savedMonthlyPrefs = localStorage.getItem("pcnArrsMonthlyPrefs");
        if (savedMonthlyPrefs) {
          const monthlyPrefs = JSON.parse(savedMonthlyPrefs);

          // Set the saved preferences
          if (monthlyPrefs.year) {
            document.getElementById("monthly-view-year").value =
              monthlyPrefs.year;
          }

          if (monthlyPrefs.viewType) {
            document.getElementById("monthly-view-type").value =
              monthlyPrefs.viewType;
          }

          // Set last updated time if available
          if (monthlyPrefs.lastUpdated) {
            const lastUpdated = new Date(monthlyPrefs.lastUpdated);
            document.getElementById("monthly-last-updated").textContent =
              lastUpdated.toLocaleString();
          }
        }

        // Load financial entitlements
        const savedFinancialData = localStorage.getItem(
          "pcnFinancialEntitlements"
        );
        if (savedFinancialData) {
          try {
            const financialData = JSON.parse(savedFinancialData);

            // Populate form fields
            document.getElementById("raw-list-size").value =
              financialData.rawListSize || "";
            document.getElementById("adjusted-population").value =
              financialData.adjustedPopulation || "";
            document.getElementById("care-home-beds").value =
              financialData.careHomeBedCount || 0;
            document.getElementById("weighted-population").value =
              financialData.weightedPopulation || "";
            document.getElementById("iif-points").value =
              financialData.iifPointsAchieved || 58;

            // Set checkboxes
            if (financialData.caipRiskStratification !== undefined) {
              document.getElementById("caip-risk-stratification").checked =
                financialData.caipRiskStratification;
            }
            if (financialData.caipModernAccess !== undefined) {
              document.getElementById("caip-modern-access").checked =
                financialData.caipModernAccess;
            }

            // Set dropdown
            if (financialData.caipAchievementMonth) {
              document.getElementById("caip-achievement-month").value =
                financialData.caipAchievementMonth;
            }

            // Run calculations to populate the results
            if (financialData.rawListSize && financialData.adjustedPopulation) {
              calculateFinancialEntitlements();
            }
          } catch (e) {
            console.error("Error loading financial entitlements:", e);
          }
        }
      }

      // Clear all data
      function clearAllData() {
        if (
          confirm(
            "Are you sure you want to clear all data? This cannot be undone."
          )
        ) {
          // Clear staff list
          localStorage.removeItem("pcnArrsStaffList");
          staffList = [];
          renderStaffList();

          // Clear monthly tracker preferences
          localStorage.removeItem("pcnArrsMonthlyPrefs");

          // Clear financial entitlements
          localStorage.removeItem("pcnFinancialEntitlements");

          // Reset financial calculator form
          resetFinanceCalculator();

          // Reset monthly view to defaults
          document.getElementById("monthly-view-type").value = "salary"; // Basic Salary
          document.getElementById("monthly-last-updated").textContent = "Never";

          // Re-populate financial years dropdown with current year selected
          populateFinancialYears();

          // Update UI
          resetMonthlyTotals();
          updateMonthlyTracker();

          // Clear backup area
          backupArea.value = "";

          showNotification("All data has been cleared");
        }
      }

      // Export to CSV
      function exportToCsv() {
        if (staffList.length === 0) {
          showNotification("No staff members to export.");
          return;
        }

        // CSV header
        let csv =
          "Name,Role,Band,Location,Experience,WTE,Start Date,Last Pay Increase,Base Salary,Annual Salary,Employer NI,Employer Pension,Total Cost,Max Reimbursable,Reimbursable Amount\n";

        // Add each staff member
        staffList.forEach((staff) => {
          const row = [
            staff.name,
            roleTitles[staff.role],
            staff.band === "gp" ? "GP Scale" : "Band " + staff.band,
            staff.location === "national"
              ? "National"
              : staff.location === "inner-london"
              ? "Inner London"
              : "Outer London",
            staff.experience === "entry"
              ? "Entry Point"
              : staff.experience === "mid"
              ? "Mid Point"
              : "Maximum Point",
            staff.wte,
            new Date(staff.startDate).toLocaleDateString(),
            staff.lastPayIncreaseDate
              ? new Date(staff.lastPayIncreaseDate).toLocaleDateString()
              : "N/A",
            staff.baseSalary.toLocaleString(),
            staff.annualSalary.toLocaleString(),
            Math.round(staff.niContribution).toLocaleString(),
            Math.round(staff.pensionContribution).toLocaleString(),
            Math.round(staff.totalCost).toLocaleString(),
            staff.maxReimbursement.toLocaleString(),
            staff.reimbursableAmount.toLocaleString(),
          ];

          // Escape commas in name field
          row[0] = `"${row[0]}"`;

          csv += row.join(",") + "\n";
        });

        // Add summary row
        let totalSalary = 0;
        let totalNi = 0;
        let totalPension = 0;
        let totalCost = 0;
        let totalReimbursable = 0;
        let totalWte = 0;

        staffList.forEach((staff) => {
          totalSalary += staff.annualSalary;
          totalNi += staff.niContribution;
          totalPension += staff.pensionContribution;
          totalCost += staff.totalCost;
          totalReimbursable += staff.reimbursableAmount;
          totalWte += staff.wte;
        });

        csv +=
          '\n"TOTAL",,,,,' +
          totalWte.toFixed(1) +
          ",," +
          "," +
          Math.round(totalSalary).toLocaleString() +
          "," +
          Math.round(totalNi).toLocaleString() +
          "," +
          Math.round(totalPension).toLocaleString() +
          "," +
          Math.round(totalCost).toLocaleString() +
          ",," +
          Math.round(totalReimbursable).toLocaleString();

        // Create CSV file
        const blob = new Blob([csv], { type: "text/csv" });
        const url = URL.createObjectURL(blob);

        // Create download link
        const a = document.createElement("a");
        a.style.display = "none";
        a.href = url;
        a.download = "pcn_arrs_workforce_plan.csv";

        // Trigger download
        document.body.appendChild(a);
        a.click();

        // Clean up
        URL.revokeObjectURL(url);
        document.body.removeChild(a);

        showNotification("CSV file exported successfully");
      }

      // Export to PDF
      function exportToPdf() {
        if (staffList.length === 0) {
          showNotification("No staff members to export.");
          return;
        }

        // Create a new window for the PDF content
        const printWindow = window.open("", "_blank", "width=1000,height=800");

        // Basic CSS for PDF layout
        const pdfStyles = `
                <style>
                    body { font-family: Arial, sans-serif; margin: 20px; }
                    h1 { color: #00999E; margin-bottom: 15px; }
                    h2 { color: #00999E; margin-top: 30px; }
                    table { width: 100%; border-collapse: collapse; margin: 20px 0; }
                    th { background-color: #00999E; color: white; padding: 8px; text-align: left; }
                    td { border-bottom: 1px solid #ddd; padding: 8px; }
                    .summary { background-color: #f0f5f5; font-weight: bold; }
                    .footer { margin-top: 40px; text-align: center; font-size: 12px; color: #666; }
                    .staff-section { margin-bottom: 30px; }
                    @media print {
                        button { display: none; }
                        body { margin: 1cm; }
                    }
                    .print-button {
                        background-color: #00999E;
                        color: white;
                        border: none;
                        padding: 10px 20px;
                        border-radius: 4px;
                        cursor: pointer;
                        font-weight: bold;
                        margin-bottom: 20px;
                    }
                    .page-break { page-break-after: always; }
                    .staff-item {
                        break-inside: avoid;
                        margin-bottom: 30px;
                        border: 1px solid #eee;
                        padding: 15px;
                        border-radius: 5px;
                    }
                </style>
            `;

        // Calculate totals
        let totalSalary = 0;
        let totalNi = 0;
        let totalPension = 0;
        let totalCost = 0;
        let totalReimbursable = 0;
        let totalWte = 0;

        staffList.forEach((staff) => {
          totalSalary += staff.annualSalary;
          totalNi += staff.niContribution;
          totalPension += staff.pensionContribution;
          totalCost += staff.totalCost;
          totalReimbursable += staff.reimbursableAmount;
          totalWte += staff.wte;
        });

        // Format date
        const today = new Date();
        const dateString = today.toLocaleDateString("en-GB", {
          day: "2-digit",
          month: "long",
          year: "numeric",
        });

        // Get PCN location
        const location = locationSelect.value;
        const locationDisplay =
          location === "national"
            ? "National"
            : location === "inner-london"
            ? "Inner London"
            : "Outer London";

        // Check if we have weighted population data
        const weightedPopulation =
          parseFloat(document.getElementById("weighted-population").value) || 0;
        let arrsEntitlement = 0;
        if (weightedPopulation > 0) {
          arrsEntitlement = financialParams.arrsPayment * weightedPopulation;
        }

        // Create HTML content
        let pdfContent = `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>PCN ARRS Workforce Plan</title>
                    ${pdfStyles}
                </head>
                <body>
                    <button class="print-button" onclick="window.print(); return false;">Print / Save as PDF</button>
                    
                    <h1>PCN ARRS Workforce Planning Report</h1>
                    <p>Generated on ${dateString}</p>
                    <p>Location: ${locationDisplay}</p>
                    
                    <h2>Workforce Summary</h2>
                    <table>
                        <tr>
                            <th>Metric</th>
                            <th>Value</th>
                        </tr>
                        <tr>
                            <td>Total Staff Members</td>
                            <td>${staffList.length}</td>
                        </tr>
                        <tr>
                            <td>Total WTE</td>
                            <td>${totalWte.toFixed(1)}</td>
                        </tr>
                        <tr>
                            <td>Total Annual Salary Costs</td>
                            <td>£${Math.round(
                              totalSalary
                            ).toLocaleString()}</td>
                        </tr>
                        <tr>
                            <td>Total Employer NI</td>
                            <td>£${Math.round(totalNi).toLocaleString()}</td>
                        </tr>
                        <tr>
                            <td>Total Employer Pension</td>
                            <td>£${Math.round(
                              totalPension
                            ).toLocaleString()}</td>
                        </tr>
                        <tr>
                            <td>Total Employment Costs</td>
                            <td>£${Math.round(totalCost).toLocaleString()}</td>
                        </tr>
            `;

        // Add ARRS entitlement if we have weighted population
        if (weightedPopulation > 0) {
          const fundingGap = arrsEntitlement - totalCost;
          const fundingText =
            fundingGap >= 0
              ? `£${Math.round(fundingGap).toLocaleString()}`
              : `-£${Math.round(Math.abs(fundingGap)).toLocaleString()}`;
          const fundingStyle = fundingGap >= 0 ? "" : "color: red;";

          pdfContent += `
                    <tr>
                        <td>Weighted Population</td>
                        <td>${weightedPopulation.toLocaleString()}</td>
                    </tr>
                    <tr>
                        <td>Maximum ARRS Funding</td>
                        <td>£${Math.round(
                          arrsEntitlement
                        ).toLocaleString()}</td>
                    </tr>
                    <tr>
                        <td>Funding Gap/Surplus</td>
                        <td style="${fundingStyle}">${fundingText}</td>
                    </tr>
                `;
        } else {
          pdfContent += `
                    <tr>
                        <td>Maximum Reimbursable Amount</td>
                        <td>£${Math.round(
                          totalReimbursable
                        ).toLocaleString()}</td>
                    </tr>
                    <tr>
                        <td>Funding Gap/Surplus</td>
                        <td>${
                          totalReimbursable - totalCost >= 0
                            ? "£" +
                              Math.round(
                                totalReimbursable - totalCost
                              ).toLocaleString()
                            : "-£" +
                              Math.round(
                                Math.abs(totalReimbursable - totalCost)
                              ).toLocaleString()
                        }</td>
                    </tr>
                `;
        }

        pdfContent += `
                    </table>
                    
                    <div class="page-break"></div>
                    
                    <h2>Staff Details</h2>
                    <div class="staff-section">
            `;

        // Add each staff member
        staffList.forEach((staff) => {
          const statusClass =
            staff.totalCost <= staff.reimbursableAmount
              ? 'style="color: green;"'
              : 'style="color: red;"';
          const statusText =
            staff.totalCost <= staff.reimbursableAmount
              ? "Within budget"
              : "Exceeds reimbursable amount";

          pdfContent += `
                    <div class="staff-item">
                        <h3>${staff.name} - ${roleTitles[staff.role]}</h3>
                        <p ${statusClass}>${statusText}</p>
                        
                        <table>
                            <tr>
                                <td><strong>Band:</strong></td>
                                <td>${
                                  staff.band === "gp"
                                    ? "GP Scale"
                                    : "Band " + staff.band
                                }</td>
                                <td><strong>Experience:</strong></td>
                                <td>${
                                  staff.experience === "entry"
                                    ? "Entry Point"
                                    : staff.experience === "mid"
                                    ? "Mid Point"
                                    : "Maximum Point"
                                }</td>
                            </tr>
                            <tr>
                                <td><strong>WTE:</strong></td>
                                <td>${staff.wte}</td>
                                <td><strong>Start Date:</strong></td>
                                <td>${new Date(
                                  staff.startDate
                                ).toLocaleDateString()}</td>
                            </tr>
                            <tr>
                                <td><strong>Last Pay Increase:</strong></td>
                                <td>${
                                  staff.lastPayIncreaseDate
                                    ? new Date(
                                        staff.lastPayIncreaseDate
                                      ).toLocaleDateString()
                                    : "N/A"
                                }</td>
                            </tr>
                            <tr>
                                <td><strong>Base Salary:</strong></td>
                                <td>£${staff.baseSalary.toLocaleString()}</td>
                                <td><strong>Annual Salary:</strong></td>
                                <td>£${staff.annualSalary.toLocaleString()}</td>
                            </tr>
                            <tr>
                                <td><strong>Employer NI:</strong></td>
                                <td>£${Math.round(
                                  staff.niContribution
                                ).toLocaleString()}</td>
                                <td><strong>Employer Pension:</strong></td>
                                <td>£${Math.round(
                                  staff.pensionContribution
                                ).toLocaleString()}</td>
                            </tr>
                            <tr>
                                <td><strong>Total Cost:</strong></td>
                                <td>£${Math.round(
                                  staff.totalCost
                                ).toLocaleString()}</td>
                                <td><strong>Max Reimbursable:</strong></td>
                                <td>£${staff.reimbursableAmount.toLocaleString()}</td>
                            </tr>
                        </table>
                    </div>
                `;
        });

        pdfContent += `
                    </div>
                    
                    <div class="footer">
                        <p>PCN ARRS Workforce Planning Calculator 2025-26 | Generated on ${dateString}</p>
                    </div>
                </body>
                </html>
            `;

        // Write content to the new window
        printWindow.document.open();
        printWindow.document.write(pdfContent);
        printWindow.document.close();

        showNotification(
          "PDF report generated. Use the Print button to save as PDF"
        );
      }

      // Export to JSON
      function exportToJson() {
        if (staffList.length === 0) {
          showNotification("No staff members to export.");
          return;
        }

        // Create formatted JSON with human-readable properties
        const formattedStaffList = staffList.map((staff) => {
          return {
            name: staff.name,
            role: roleTitles[staff.role],
            role_code: staff.role,
            band: staff.band === "gp" ? "GP Scale" : "Band " + staff.band,
            band_code: staff.band,
            location:
              staff.location === "national"
                ? "National"
                : staff.location === "inner-london"
                ? "Inner London"
                : "Outer London",
            location_code: staff.location,
            experience:
              staff.experience === "entry"
                ? "Entry Point"
                : staff.experience === "mid"
                ? "Mid Point"
                : "Maximum Point",
            experience_code: staff.experience,
            wte: staff.wte,
            start_date: staff.startDate,
            last_pay_increase: staff.lastPayIncreaseDate,
            base_salary: staff.baseSalary,
            annual_salary: staff.annualSalary,
            ni_contribution: Math.round(staff.niContribution),
            pension_contribution: Math.round(staff.pensionContribution),
            total_cost: Math.round(staff.totalCost),
            max_reimbursement: staff.maxReimbursement,
            reimbursable_amount: staff.reimbursableAmount,
            is_within_budget: staff.totalCost <= staff.reimbursableAmount,
            salary_override: staff.salaryOverride,
          };
        });

        // Add summary data
        let totalSalary = 0;
        let totalNi = 0;
        let totalPension = 0;
        let totalCost = 0;
        let totalReimbursable = 0;
        let totalWte = 0;

        staffList.forEach((staff) => {
          totalSalary += staff.annualSalary;
          totalNi += staff.niContribution;
          totalPension += staff.pensionContribution;
          totalCost += staff.totalCost;
          totalReimbursable += staff.reimbursableAmount;
          totalWte += staff.wte;
        });

        // Get weighted population if available
        const weightedPopulation =
          parseFloat(document.getElementById("weighted-population").value) || 0;
        let arrsEntitlement = 0;
        if (weightedPopulation > 0) {
          arrsEntitlement = financialParams.arrsPayment * weightedPopulation;
        }

        // Get current date for export timestamp
        const exportDate = new Date().toISOString();

        // Create the full export object
        const exportData = {
          export_date: exportDate,
          export_type: "PCN ARRS Workforce Plan",
          export_version: "2025-26",
          summary: {
            total_staff: staffList.length,
            total_wte: parseFloat(totalWte.toFixed(1)),
            total_annual_salary: Math.round(totalSalary),
            total_ni: Math.round(totalNi),
            total_pension: Math.round(totalPension),
            total_cost: Math.round(totalCost),
            total_reimbursable: Math.round(totalReimbursable),
          },
          weighted_population:
            weightedPopulation > 0
              ? {
                  population: weightedPopulation,
                  arrs_entitlement: Math.round(arrsEntitlement),
                  funding_gap: Math.round(arrsEntitlement - totalCost),
                }
              : null,
          staff: formattedStaffList,
        };

        // Convert to JSON string
        const jsonString = JSON.stringify(exportData, null, 2);

        // Create file and trigger download
        const blob = new Blob([jsonString], { type: "application/json" });
        const url = URL.createObjectURL(blob);

        const a = document.createElement("a");
        a.style.display = "none";
        a.href = url;
        a.download = "pcn_arrs_workforce_plan.json";

        document.body.appendChild(a);
        a.click();

        URL.revokeObjectURL(url);
        document.body.removeChild(a);

        showNotification("JSON file exported successfully");
      }

      // Copy backup data
      function copyBackupData() {
        backupArea.select();
        document.execCommand("copy");
        showNotification("Data copied to clipboard");
      }

      // Show notification
      let notificationQueue = [];
      let isNotificationActive = false;

      function showNotification(message) {
        console.log("Showing notification:", message);
        // Add to queue
        notificationQueue.push(message);

        // If no active notification, show this one
        if (!isNotificationActive) {
          displayNextNotification();
        }
      }

      function displayNextNotification() {
        if (notificationQueue.length === 0) return;

        isNotificationActive = true;
        const message = notificationQueue[0];

        const notification = document.createElement("div");
        notification.className = "notification";
        notification.textContent = message;
        document.body.appendChild(notification);

        setTimeout(() => {
          notification.classList.add("show");

          setTimeout(() => {
            notification.classList.remove("show");
            setTimeout(() => {
              document.body.removeChild(notification);
              // Process next notification
              notificationQueue.shift();
              isNotificationActive = false;
              if (notificationQueue.length > 0) {
                displayNextNotification();
              }
            }, 300);
          }, 2000);
        }, 10);
      }

      // Restore backup data
      function restoreBackupData() {
        try {
          const data = JSON.parse(backupArea.value);

          // Handle both old format (array only) and new format (object with properties)
          if (Array.isArray(data)) {
            // Old format - just staff list
            staffList = data;
          } else if (data.staffList && Array.isArray(data.staffList)) {
            // New format - object with properties
            staffList = data.staffList;

            // Restore monthly preferences if available
            if (data.monthlyPrefs) {
              const monthlyPrefs = data.monthlyPrefs;

              if (monthlyPrefs.year) {
                document.getElementById("monthly-view-year").value =
                  monthlyPrefs.year;
              }

              if (monthlyPrefs.viewType) {
                document.getElementById("monthly-view-type").value =
                  monthlyPrefs.viewType;
              }

              // Store the preferences in localStorage
              localStorage.setItem(
                "pcnArrsMonthlyPrefs",
                JSON.stringify(monthlyPrefs)
              );
            }

            // Restore financial data if available
            if (data.financialData) {
              // Save to localStorage
              localStorage.setItem(
                "pcnFinancialEntitlements",
                JSON.stringify(data.financialData)
              );

              // Populate form fields
              document.getElementById("raw-list-size").value =
                data.financialData.rawListSize || "";
              document.getElementById("adjusted-population").value =
                data.financialData.adjustedPopulation || "";
              document.getElementById("care-home-beds").value =
                data.financialData.careHomeBedCount || 0;
              document.getElementById("weighted-population").value =
                data.financialData.weightedPopulation || "";
              document.getElementById("iif-points").value =
                data.financialData.iifPointsAchieved || 58;

              // Set checkboxes
              if (data.financialData.caipRiskStratification !== undefined) {
                document.getElementById("caip-risk-stratification").checked =
                  data.financialData.caipRiskStratification;
              }
              if (data.financialData.caipModernAccess !== undefined) {
                document.getElementById("caip-modern-access").checked =
                  data.financialData.caipModernAccess;
              }

              // Set dropdown
              if (data.financialData.caipAchievementMonth) {
                document.getElementById("caip-achievement-month").value =
                  data.financialData.caipAchievementMonth;
              }

              // Calculate financial entitlements if we have data
              if (
                data.financialData.rawListSize &&
                data.financialData.adjustedPopulation
              ) {
                calculateFinancialEntitlements();
              }
            }
          } else {
            throw new Error("Invalid data format");
          }

          // Save data and update UI
          saveData();
          renderStaffList();
          updateMonthlyTracker();

          showNotification("Data restored successfully");
        } catch (error) {
          showNotification(
            "Error restoring data. Please check the format and try again."
          );
          console.error(error);
        }
      }

      // Populate forecast years dropdown
      function populateForecastYears() {
        const yearSelect = document.getElementById("forecast-year");
        yearSelect.innerHTML = ""; // Clear existing options

        // Get current date
        const currentDate = new Date();
        const currentMonth = currentDate.getMonth(); // 0-11 (Jan-Dec)

        // Determine the current financial year
        let currentFY;
        if (currentMonth >= 3) {
          // April onwards
          currentFY = currentDate.getFullYear();
        } else {
          // January to March
          currentFY = currentDate.getFullYear() - 1;
        }

        // For forecasting, we want the next year as default and 3 years ahead
        // So we start with next year and go forward
        const startYear = currentFY + 1; // Next financial year
        const endYear = currentFY + 5; // 5 years ahead for planning

        for (let year = startYear; year <= endYear; year++) {
          const option = document.createElement("option");
          option.value = year;
          option.textContent = `${year}-${year + 1}`;

          // Set next financial year as selected by default
          if (year === startYear) {
            option.selected = true;
          }

          yearSelect.appendChild(option);
        }
      }

      // Toggle forecast options based on selected scenario
      function toggleForecastOptions() {
        const scenario = document.getElementById("forecast-scenario").value;

        // Hide all scenario-specific options first
        document.getElementById("forecast-growth-options").style.display =
          "none";
        document.getElementById("forecast-reduction-options").style.display =
          "none";

        // Show relevant options based on scenario
        if (scenario === "growth") {
          document.getElementById("forecast-growth-options").style.display =
            "block";
        } else if (scenario === "reduction") {
          document.getElementById("forecast-reduction-options").style.display =
            "block";
        }

        // Run the forecast immediately when changing scenarios
        // Only if we have staff added
        if (staffList.length > 0) {
          updateForecast();
        }
      }

      // Update forecast based on settings
      function updateForecast() {
        if (staffList.length === 0) {
          showNotification("No staff members to forecast.");
          document.getElementById("forecast-staff-body").innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 20px;">
                            No staff members added yet. Use the ARRS Calculator tab to add staff.
                        </td>
                    </tr>
                `;
          return;
        }

        // Get forecast settings
        const forecastYear = parseInt(
          document.getElementById("forecast-year").value
        );
        const scenario = document.getElementById("forecast-scenario").value;
        const salaryIncreasePercent =
          parseFloat(
            document.getElementById("forecast-salary-increase").value
          ) / 100;

        // Get specific scenario settings
        let growthStaffCount = 0;
        let reductionPercent = 0;
        let naturalAttrition = true;

        if (scenario === "growth") {
          growthStaffCount =
            parseInt(document.getElementById("forecast-growth-staff").value) ||
            0;
        } else if (scenario === "reduction") {
          reductionPercent =
            parseFloat(
              document.getElementById("forecast-reduction-percent").value
            ) / 100;
          naturalAttrition = document.getElementById(
            "forecast-reduction-natural"
          ).checked;
        }

        // Create deep copy of current staff list
        const currentStaff = JSON.parse(JSON.stringify(staffList));

        // Generate projected staff list with salary increases
        let forecastStaff = currentStaff.map((staff) => {
          // Create a projected copy of the staff member
          const projectedStaff = { ...staff };

          // Apply salary increase
          const salaryIncreaseFactor = 1 + salaryIncreasePercent;
          projectedStaff.baseSalary *= salaryIncreaseFactor;
          projectedStaff.annualSalary =
            projectedStaff.baseSalary * projectedStaff.wte;

          // Recalculate NI and pension contributions
          projectedStaff.niContribution = Math.max(
            0,
            (projectedStaff.annualSalary - NI_THRESHOLD) * NI_RATE
          );
          projectedStaff.pensionContribution =
            projectedStaff.annualSalary * PENSION_RATE;
          projectedStaff.totalCost =
            projectedStaff.annualSalary +
            projectedStaff.niContribution +
            projectedStaff.pensionContribution;

          // Assume reimbursable amount also increases (keeping pace with inflation)
          // This is a simplification - in reality, NHSE would need to confirm actual increases
          projectedStaff.maxReimbursement *= salaryIncreaseFactor;
          projectedStaff.reimbursableAmount =
            projectedStaff.maxReimbursement * projectedStaff.wte;

          return projectedStaff;
        });

        // Apply scenario-specific logic
        if (scenario === "growth") {
          // Add new placeholder staff for growth scenario
          for (let i = 0; i < growthStaffCount; i++) {
            // Use a simple average of existing staff for the placeholder
            // This is a simplification - in reality, specific roles would be planned
            const avgSalary =
              forecastStaff.reduce((sum, s) => sum + s.baseSalary, 0) /
              forecastStaff.length;
            const avgReimbursement =
              forecastStaff.reduce((sum, s) => sum + s.maxReimbursement, 0) /
              forecastStaff.length;

            const newStaff = {
              id: `forecast-new-${i}`,
              name: `New Role ${i + 1}`,
              role: "clinical-pharmacist", // Placeholder role
              band: "7", // Common band for clinical roles
              location: locationSelect.value,
              experience: "mid",
              wte: 1.0,
              startDate: new Date(forecastYear, 3, 1).toISOString(), // April 1st of forecast year
              lastPayIncreaseDate: new Date(forecastYear, 3, 1).toISOString(),
              baseSalary: avgSalary,
              annualSalary: avgSalary,
              niContribution: Math.max(0, (avgSalary - NI_THRESHOLD) * NI_RATE),
              pensionContribution: avgSalary * PENSION_RATE,
              maxReimbursement: avgReimbursement,
              reimbursableAmount: avgReimbursement,
              isNewForecast: true, // Flag to identify new roles in the forecast
            };

            newStaff.totalCost =
              newStaff.annualSalary +
              newStaff.niContribution +
              newStaff.pensionContribution;

            forecastStaff.push(newStaff);
          }
        } else if (scenario === "reduction") {
          if (naturalAttrition) {
            // Sort by start date (oldest first) and reduce by percentage
            forecastStaff.sort(
              (a, b) => new Date(a.startDate) - new Date(b.startDate)
            );
          } else {
            // Sort by cost effectiveness (least cost-effective first)
            // Cost effectiveness = reimbursable amount / total cost
            forecastStaff.sort((a, b) => {
              const aEfficiency = a.reimbursableAmount / a.totalCost;
              const bEfficiency = b.reimbursableAmount / b.totalCost;
              return aEfficiency - bEfficiency;
            });
          }

          // Calculate how many staff to reduce
          const staffToReduceCount = Math.ceil(
            forecastStaff.length * reductionPercent
          );

          // Remove the calculated number of staff
          forecastStaff = forecastStaff.slice(staffToReduceCount);
        }

        // Format currency for display
        const formatter = new Intl.NumberFormat("en-UK", {
          style: "currency",
          currency: "GBP",
          minimumFractionDigits: 0,
          maximumFractionDigits: 0,
        });

        // Calculate summary metrics for both current and forecast
        const currentSummary = calculateStaffSummary(currentStaff);
        const forecastSummary = calculateStaffSummary(forecastStaff);

        // Update summary comparison table
        document.getElementById("forecast-current-staff").textContent =
          currentStaff.length;
        document.getElementById("forecast-future-staff").textContent =
          forecastStaff.length;
        document.getElementById("forecast-change-staff").textContent =
          forecastStaff.length - currentStaff.length;

        document.getElementById("forecast-current-wte").textContent =
          currentSummary.totalWte.toFixed(1);
        document.getElementById("forecast-future-wte").textContent =
          forecastSummary.totalWte.toFixed(1);
        document.getElementById("forecast-change-wte").textContent = (
          forecastSummary.totalWte - currentSummary.totalWte
        ).toFixed(1);

        document.getElementById("forecast-current-salary").textContent =
          formatter.format(Math.round(currentSummary.totalSalary));
        document.getElementById("forecast-future-salary").textContent =
          formatter.format(Math.round(forecastSummary.totalSalary));
        document.getElementById("forecast-change-salary").textContent =
          formatter.format(
            Math.round(forecastSummary.totalSalary - currentSummary.totalSalary)
          );

        document.getElementById("forecast-current-total").textContent =
          formatter.format(Math.round(currentSummary.totalCost));
        document.getElementById("forecast-future-total").textContent =
          formatter.format(Math.round(forecastSummary.totalCost));
        document.getElementById("forecast-change-total").textContent =
          formatter.format(
            Math.round(forecastSummary.totalCost - currentSummary.totalCost)
          );

        // Calculate funding based on weighted population with configurable annual increase
        const weightedPopulation =
          parseFloat(document.getElementById("weighted-population").value) || 0;
        const arrsIncreasePct =
          parseFloat(document.getElementById("forecast-arrs-increase").value) /
          100;
        const currentFunding = weightedPopulation * financialParams.arrsPayment;
        const forecastFunding =
          weightedPopulation *
          financialParams.arrsPayment *
          (1 + arrsIncreasePct);

        document.getElementById("forecast-current-funding").textContent =
          formatter.format(Math.round(currentFunding));
        document.getElementById("forecast-future-funding").textContent =
          formatter.format(Math.round(forecastFunding));
        document.getElementById("forecast-change-funding").textContent =
          formatter.format(Math.round(forecastFunding - currentFunding));

        const currentGap = currentFunding - currentSummary.totalCost;
        const forecastGap = forecastFunding - forecastSummary.totalCost;

        // Format gap/surplus with styling
        const formatGap = (gap) => {
          if (gap >= 0) {
            return formatter.format(Math.round(gap));
          } else {
            return "-" + formatter.format(Math.round(Math.abs(gap)));
          }
        };

        document.getElementById("forecast-current-gap").textContent =
          formatGap(currentGap);
        document.getElementById("forecast-future-gap").textContent =
          formatGap(forecastGap);
        document.getElementById("forecast-change-gap").textContent = formatGap(
          forecastGap - currentGap
        );

        // Apply color highlighting to gaps
        const styleGapCell = (cellId, value) => {
          const cell = document.getElementById(cellId);
          if (value >= 0) {
            cell.style.color = "var(--success-color)";
          } else {
            cell.style.color = "var(--warning-color)";
          }
        };

        styleGapCell("forecast-current-gap", currentGap);
        styleGapCell("forecast-future-gap", forecastGap);
        styleGapCell("forecast-change-gap", forecastGap - currentGap);

        // Update detailed staff table
        const staffTableBody = document.getElementById("forecast-staff-body");
        staffTableBody.innerHTML = "";

        // Create a map of forecast staff by ID for easy lookup
        const forecastStaffMap = {};
        forecastStaff.forEach((staff) => {
          forecastStaffMap[staff.id] = staff;
        });

        // Add rows for current staff with their projected values
        currentStaff.forEach((staff) => {
          const row = document.createElement("tr");

          // Get the corresponding forecast staff if it exists
          const forecastStaffMember = forecastStaffMap[staff.id];

          // Check if this staff member is included in the forecast
          if (forecastStaffMember) {
            // Style based on role type
            row.style.backgroundColor = "transparent";

            // First column: Staff name and role
            const nameCell = document.createElement("td");
            nameCell.innerHTML = `<strong>${
              staff.name
            }</strong><br><span style="font-size: 0.8em;">${
              roleTitles[staff.role]
            }</span>`;
            row.appendChild(nameCell);

            // Current salary
            const currentSalaryCell = document.createElement("td");
            currentSalaryCell.textContent = formatter.format(
              Math.round(staff.annualSalary)
            );
            currentSalaryCell.style.textAlign = "right";
            row.appendChild(currentSalaryCell);

            // Forecast salary
            const forecastSalaryCell = document.createElement("td");
            forecastSalaryCell.textContent = formatter.format(
              Math.round(forecastStaffMember.annualSalary)
            );
            forecastSalaryCell.style.textAlign = "right";
            row.appendChild(forecastSalaryCell);

            // Current total cost
            const currentCostCell = document.createElement("td");
            currentCostCell.textContent = formatter.format(
              Math.round(staff.totalCost)
            );
            currentCostCell.style.textAlign = "right";
            row.appendChild(currentCostCell);

            // Forecast total cost
            const forecastCostCell = document.createElement("td");
            forecastCostCell.textContent = formatter.format(
              Math.round(forecastStaffMember.totalCost)
            );
            forecastCostCell.style.textAlign = "right";
            row.appendChild(forecastCostCell);

            // Change
            const changeCell = document.createElement("td");
            const change = forecastStaffMember.totalCost - staff.totalCost;
            changeCell.textContent = formatter.format(Math.round(change));
            changeCell.style.textAlign = "right";
            changeCell.style.fontWeight = "bold";

            // Color code change
            if (change > 0) {
              changeCell.style.color = "var(--warning-color)";
            } else if (change < 0) {
              changeCell.style.color = "var(--success-color)";
            }

            row.appendChild(changeCell);
          } else {
            // This staff member is not in the forecast (removed)
            row.style.backgroundColor = "#ffebee"; // Light red background

            // First column: Staff name and role
            const nameCell = document.createElement("td");
            nameCell.innerHTML = `<strong>${
              staff.name
            }</strong><br><span style="font-size: 0.8em;">${
              roleTitles[staff.role]
            }</span><br><span style="color: var(--warning-color);">[Removed in forecast]</span>`;
            row.appendChild(nameCell);

            // Current salary
            const currentSalaryCell = document.createElement("td");
            currentSalaryCell.textContent = formatter.format(
              Math.round(staff.annualSalary)
            );
            currentSalaryCell.style.textAlign = "right";
            row.appendChild(currentSalaryCell);

            // Forecast salary (N/A)
            const forecastSalaryCell = document.createElement("td");
            forecastSalaryCell.textContent = "N/A";
            forecastSalaryCell.style.textAlign = "right";
            forecastSalaryCell.style.color = "#999";
            row.appendChild(forecastSalaryCell);

            // Current total cost
            const currentCostCell = document.createElement("td");
            currentCostCell.textContent = formatter.format(
              Math.round(staff.totalCost)
            );
            currentCostCell.style.textAlign = "right";
            row.appendChild(currentCostCell);

            // Forecast total cost (N/A)
            const forecastCostCell = document.createElement("td");
            forecastCostCell.textContent = "N/A";
            forecastCostCell.style.textAlign = "right";
            forecastCostCell.style.color = "#999";
            row.appendChild(forecastCostCell);

            // Change
            const changeCell = document.createElement("td");
            changeCell.textContent =
              "-" + formatter.format(Math.round(staff.totalCost));
            changeCell.style.textAlign = "right";
            changeCell.style.fontWeight = "bold";
            changeCell.style.color = "var(--success-color)";
            row.appendChild(changeCell);
          }

          staffTableBody.appendChild(row);
        });

        // Add new staff members that are only in the forecast
        forecastStaff.forEach((staff) => {
          // Skip if this staff member was already in the current staff list
          if (currentStaff.some((s) => s.id === staff.id)) {
            return;
          }

          // This is a new staff member in the forecast
          const row = document.createElement("tr");
          row.style.backgroundColor = "#e8f5e9"; // Light green background

          // First column: Staff name and role
          const nameCell = document.createElement("td");
          nameCell.innerHTML = `<strong>${
            staff.name
          }</strong><br><span style="font-size: 0.8em;">${
            roleTitles[staff.role]
          }</span><br><span style="color: var(--success-color);">[New in forecast]</span>`;
          row.appendChild(nameCell);

          // Current salary (N/A)
          const currentSalaryCell = document.createElement("td");
          currentSalaryCell.textContent = "N/A";
          currentSalaryCell.style.textAlign = "right";
          currentSalaryCell.style.color = "#999";
          row.appendChild(currentSalaryCell);

          // Forecast salary
          const forecastSalaryCell = document.createElement("td");
          forecastSalaryCell.textContent = formatter.format(
            Math.round(staff.annualSalary)
          );
          forecastSalaryCell.style.textAlign = "right";
          row.appendChild(forecastSalaryCell);

          // Current total cost (N/A)
          const currentCostCell = document.createElement("td");
          currentCostCell.textContent = "N/A";
          currentCostCell.style.textAlign = "right";
          currentCostCell.style.color = "#999";
          row.appendChild(currentCostCell);

          // Forecast total cost
          const forecastCostCell = document.createElement("td");
          forecastCostCell.textContent = formatter.format(
            Math.round(staff.totalCost)
          );
          forecastCostCell.style.textAlign = "right";
          row.appendChild(forecastCostCell);

          // Change
          const changeCell = document.createElement("td");
          changeCell.textContent = formatter.format(
            Math.round(staff.totalCost)
          );
          changeCell.style.textAlign = "right";
          changeCell.style.fontWeight = "bold";
          changeCell.style.color = "var(--warning-color)";
          row.appendChild(changeCell);

          staffTableBody.appendChild(row);
        });

        // Update location display
        const location = locationSelect.value;
        document.getElementById("forecast-location-display").textContent =
          "Location: " +
          (location === "national"
            ? "National"
            : location === "inner-london"
            ? "Inner London"
            : "Outer London");

        // Store the forecast data for later use
        window.currentForecast = {
          currentStaff,
          forecastStaff,
          forecastYear,
          scenario,
          salaryIncreasePct: parseFloat(
            document.getElementById("forecast-salary-increase").value
          ),
          arrsIncreasePct: parseFloat(
            document.getElementById("forecast-arrs-increase").value
          ),
          timestamp: new Date().toISOString(),
        };

        showNotification("Forecast updated successfully");
      }

      // Save financial entitlements data
      function saveFinancialEntitlements() {
        // Check if calculations have been run
        if (
          document.getElementById("finance-results-section").style.display ===
          "none"
        ) {
          showNotification(
            "Please calculate entitlements first before saving."
          );
          return;
        }

        // Get all input values
        const financialData = {
          rawListSize:
            parseFloat(document.getElementById("raw-list-size").value) || 0,
          adjustedPopulation:
            parseFloat(document.getElementById("adjusted-population").value) ||
            0,
          careHomeBedCount:
            parseInt(document.getElementById("care-home-beds").value) || 0,
          weightedPopulation:
            parseFloat(document.getElementById("weighted-population").value) ||
            0,
          iifPointsAchieved:
            parseInt(document.getElementById("iif-points").value) || 0,
          caipRiskStratification: document.getElementById(
            "caip-risk-stratification"
          ).checked,
          caipModernAccess:
            document.getElementById("caip-modern-access").checked,
          caipAchievementMonth: parseInt(
            document.getElementById("caip-achievement-month").value
          ),
        };

        // Save calculated results
        financialData.results = {
          corePCN: {
            annual: document.getElementById("core-pcn-funding-annual")
              .textContent,
            monthly: document.getElementById("core-pcn-funding-monthly")
              .textContent,
          },
          enhancedAccess: {
            annual: document.getElementById("enhanced-access-annual")
              .textContent,
            monthly: document.getElementById("enhanced-access-monthly")
              .textContent,
          },
          careHomePremium: {
            annual: document.getElementById("care-home-premium-annual")
              .textContent,
            monthly: document.getElementById("care-home-premium-monthly")
              .textContent,
          },
          capacityAccess: {
            annual: document.getElementById("capacity-access-annual")
              .textContent,
            monthly: document.getElementById("capacity-access-monthly")
              .textContent,
          },
          caip: {
            annual: document.getElementById("caip-annual").textContent,
            monthly: document.getElementById("caip-monthly").textContent,
          },
          iif: {
            annual: document.getElementById("iif-annual").textContent,
            monthly: document.getElementById("iif-monthly").textContent,
          },
          arrs: {
            annual: document.getElementById("arrs-annual").textContent,
            monthly: document.getElementById("arrs-monthly").textContent,
          },
          subtotal: {
            annual: document.getElementById("subtotal-annual").textContent,
            monthly: document.getElementById("subtotal-monthly").textContent,
          },
          total: {
            annual: document.getElementById("total-annual").textContent,
            monthly: document.getElementById("total-monthly").textContent,
          },
        };

        // Add timestamp
        financialData.timestamp = new Date().toISOString();
        financialData.financialYear = "2025-26";

        // Save to localStorage
        localStorage.setItem(
          "pcnFinancialEntitlements",
          JSON.stringify(financialData)
        );

        // Also update the complete data object for backups
        if (document.querySelector('.tab-content[data-tab="data"].active')) {
          // If we're on the data tab, get existing backup data or create fresh
          let completeData;
          try {
            completeData = JSON.parse(backupArea.value);
            if (!completeData || typeof completeData !== "object") {
              completeData = {
                staffList: staffList,
                version: "2025-26",
              };
            }
          } catch (e) {
            completeData = {
              staffList: staffList,
              version: "2025-26",
            };
          }

          // Add financial data to the complete data object
          completeData.financialData = financialData;

          // Update backup area
          backupArea.value = JSON.stringify(completeData, null, 2);
        }

        showNotification("Financial entitlements saved successfully");
      }

      // Calculate summary totals from a staff list
      function calculateStaffSummary(staffList) {
        let totalSalary = 0;
        let totalNi = 0;
        let totalPension = 0;
        let totalCost = 0;
        let totalReimbursable = 0;
        let totalWte = 0;

        staffList.forEach((staff) => {
          totalSalary += staff.annualSalary;
          totalNi += staff.niContribution;
          totalPension += staff.pensionContribution;
          totalCost += staff.totalCost;
          totalReimbursable += staff.reimbursableAmount;
          totalWte += staff.wte;
        });

        return {
          totalSalary,
          totalNi,
          totalPension,
          totalCost,
          totalReimbursable,
          totalWte,
        };
      }

      // Export forecast to CSV
      function exportForecastToCsv() {
        if (!window.currentForecast) {
          showNotification("Please generate a forecast first.");
          return;
        }

        const { currentStaff, forecastStaff, forecastYear, scenario } =
          window.currentForecast;

        // Create CSV header
        let csv =
          "Staff Member,Role,Current Salary,Forecast Salary,Current Total Cost,Forecast Total Cost,Change\n";

        // Format for values
        const formatValue = (value) => {
          if (value === null || value === undefined || isNaN(value)) {
            return "N/A";
          }
          return Math.round(value).toLocaleString();
        };

        // Create a map of forecast staff by ID for easy lookup
        const forecastStaffMap = {};
        forecastStaff.forEach((staff) => {
          forecastStaffMap[staff.id] = staff;
        });

        // Add rows for current staff with their projected values
        currentStaff.forEach((staff) => {
          const forecastStaffMember = forecastStaffMap[staff.id];

          if (forecastStaffMember) {
            // Staff is in both current and forecast
            const row = [
              `"${staff.name}"`,
              `"${roleTitles[staff.role]}"`,
              formatValue(staff.annualSalary),
              formatValue(forecastStaffMember.annualSalary),
              formatValue(staff.totalCost),
              formatValue(forecastStaffMember.totalCost),
              formatValue(forecastStaffMember.totalCost - staff.totalCost),
            ];
            csv += row.join(",") + "\n";
          } else {
            // Staff is only in current, not in forecast
            const row = [
              `"${staff.name} [Removed in forecast]"`,
              `"${roleTitles[staff.role]}"`,
              formatValue(staff.annualSalary),
              "N/A",
              formatValue(staff.totalCost),
              "N/A",
              "-" + formatValue(staff.totalCost),
            ];
            csv += row.join(",") + "\n";
          }
        });

        // Add new staff members that are only in the forecast
        forecastStaff.forEach((staff) => {
          // Skip if this staff member was already in the current staff list
          if (currentStaff.some((s) => s.id === staff.id)) {
            return;
          }

          // Staff is only in forecast, not in current
          const row = [
            `"${staff.name} [New in forecast]"`,
            `"${roleTitles[staff.role]}"`,
            "N/A",
            formatValue(staff.annualSalary),
            "N/A",
            formatValue(staff.totalCost),
            formatValue(staff.totalCost),
          ];
          csv += row.join(",") + "\n";
        });

        // Add summary rows
        const currentSummary = calculateStaffSummary(currentStaff);
        const forecastSummary = calculateStaffSummary(forecastStaff);

        csv += "\n";
        csv += `"SUMMARY","","","","","",""`;
        csv += "\n";

        csv += `"Total Staff",${currentStaff.length},${
          forecastStaff.length
        },,,${forecastStaff.length - currentStaff.length}`;
        csv += "\n";

        csv += `"Total WTE",${currentSummary.totalWte.toFixed(
          1
        )},${forecastSummary.totalWte.toFixed(1)},,,${(
          forecastSummary.totalWte - currentSummary.totalWte
        ).toFixed(1)}`;
        csv += "\n";

        csv += `"Total Salary",${formatValue(
          currentSummary.totalSalary
        )},${formatValue(forecastSummary.totalSalary)},,,${formatValue(
          forecastSummary.totalSalary - currentSummary.totalSalary
        )}`;
        csv += "\n";

        csv += `"Total Cost",${formatValue(
          currentSummary.totalCost
        )},${formatValue(forecastSummary.totalCost)},,,${formatValue(
          forecastSummary.totalCost - currentSummary.totalCost
        )}`;
        csv += "\n\n";

        // Add metadata
        const salaryIncreasePct = parseFloat(
          document.getElementById("forecast-salary-increase").value
        );
        const arrsIncreasePct = parseFloat(
          document.getElementById("forecast-arrs-increase").value
        );

        csv += `"Forecast Year: ${forecastYear}-${forecastYear + 1}"`;
        csv += "\n";

        csv += `"Scenario: ${
          scenario === "current"
            ? "Current Staff Only"
            : scenario === "growth"
            ? "Growth (Added Staff)"
            : "Reduction (Removed Staff)"
        }"`;
        csv += "\n";

        csv += `"Annual Salary Increase: ${salaryIncreasePct.toFixed(1)}%"`;
        csv += "\n";

        csv += `"ARRS Funding Increase: ${arrsIncreasePct.toFixed(1)}%"`;
        csv += "\n";

        csv += `"Generated: ${new Date().toLocaleString()}"`;

        // Create and trigger download
        const blob = new Blob([csv], { type: "text/csv" });
        const url = URL.createObjectURL(blob);

        const a = document.createElement("a");
        a.style.display = "none";
        a.href = url;
        a.download = `pcn_arrs_forecast_${forecastYear}-${
          forecastYear + 1
        }.csv`;

        document.body.appendChild(a);
        a.click();

        URL.revokeObjectURL(url);
        document.body.removeChild(a);

        showNotification("Forecast exported to CSV");
      }

      // Save the current forecast scenario
      function saveForecastScenario() {
        if (!window.currentForecast) {
          showNotification("Please generate a forecast first.");
          return;
        }

        // Get scenario name from user
        const scenarioName = prompt(
          "Enter a name for this forecast scenario:",
          `Forecast ${window.currentForecast.forecastYear}-${
            window.currentForecast.forecastYear + 1
          } ${window.currentForecast.scenario}`
        );

        if (!scenarioName) {
          return; // User cancelled
        }

        // Get existing scenarios or initialize empty array
        let savedScenarios = JSON.parse(
          localStorage.getItem("pcnArrsForecastScenarios") || "[]"
        );

        // Add new scenario
        savedScenarios.push({
          name: scenarioName,
          ...window.currentForecast,
        });

        // Keep only the most recent 10 scenarios
        if (savedScenarios.length > 10) {
          savedScenarios = savedScenarios.slice(-10);
        }

        // Save back to localStorage
        localStorage.setItem(
          "pcnArrsForecastScenarios",
          JSON.stringify(savedScenarios)
        );

        showNotification(
          `Forecast scenario "${scenarioName}" saved successfully`
        );
      }

      // Add copyright notices to all tabs
      function addCopyrightNotices() {
        // First, remove any existing copyright notices to avoid duplicates
        document.querySelectorAll(".copyright-notice").forEach((notice) => {
          notice.remove();
        });

        // Get all tab content divs
        const tabContents = document.querySelectorAll(".tab-content");

        // Add copyright notice to each tab
        tabContents.forEach((tab) => {
          const copyrightDiv = document.createElement("div");
          copyrightDiv.className = "copyright-notice";
          copyrightDiv.innerHTML =
            "© THC Primary Care and Tara Humphrey Consulting Ltd";
          tab.appendChild(copyrightDiv);
        });
      }

      // Add copyright notices after DOM is fully loaded
      document.addEventListener("DOMContentLoaded", addCopyrightNotices);

      // Also call immediately in case DOM is already loaded
      addCopyrightNotices();
    </script>
    <script src="auth-bridge.js"></script>
  </body>
</html>
